{
  "name": "KommoCRM Integration",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "send-to-kommocrm",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "8aca6c85-083c-46e8-9005-f7c5486685cc",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -4896,
        320
      ],
      "webhookId": "amocrm-webhook"
    },
    {
      "parameters": {
        "jsCode": "const CLIENT_CONFIG = {\n  // === –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò ===\n  clientName: 'Cryptomator',\n  subdomain: 'evgenstrizh',\n  accountId: 35434799,\n  pipelineId: 12289079,\n  pipelineName: 'Cryptomator',\n\n  // === –ü–û–õ–ù–´–ô –°–ü–ò–°–û–ö –°–¢–ê–î–ò–ô ===\n  stages: [\n    { id: 94980771, name: 'Incoming leads', sort: 10, type: 1, color: '#c1c1c1', isUnsorted: true },\n    { id: 94980775, name: 'Initial Contact', sort: 20, type: 0, color: '#99ccff' },\n    { id: 94980779, name: 'Offer made', sort: 30, type: 0, color: '#ffff99' },\n    { id: 94980783, name: 'Negotiation', sort: 40, type: 0, color: '#ffcc66' },\n    { id: 142, name: 'Closed - won', sort: 10000, type: 0, color: '#CCFF66', isSuccess: true },\n    { id: 143, name: 'Closed - lost', sort: 11000, type: 0, color: '#D5D8DB', isClosed: true }\n  ],\n\n  // === –ú–ê–ü–ü–ò–ù–ì –°–¢–ê–î–ò–ô –ü–û –¢–ï–ú–ü–ï–†–ê–¢–£–†–ï ===\n  stageMapping: {\n    hot: 94980783,      // Negotiation\n    warm: 94980779,     // Offer made\n    cold: 94980775      // Initial Contact\n  },\n\n  // === ID –ö–ê–°–¢–û–ú–ù–´–• –ü–û–õ–ï–ô –ö–û–ù–¢–ê–ö–¢–û–í ===\n  customFields: {\n    position: 668708,      // Position\n    phone: 668710,      // Phone\n    email: 668712,      // Email\n    company: 730828      // Company\n  },\n\n  // === ENUM ID –î–õ–Ø –¢–ò–ü–û–í –¢–ï–õ–ï–§–û–ù–û–í ===\n  phoneEnums: {\n    WORK: 524756,\n    WORKDD: 524758,\n    MOB: 524760,\n    FAX: 524762,\n    HOME: 524764,\n    OTHER: 524766\n  },\n\n  // === ENUM ID –î–õ–Ø –¢–ò–ü–û–í EMAIL ===\n  emailEnums: {\n    WORK: 524768,\n    PRIV: 524770,\n    OTHER: 524772\n  },\n\n  // === –ë–ê–ó–û–í–´–ï –ù–ê–°–¢–†–û–ô–ö–ò ===\n  defaultManagerId: 14090375,\n  defaultCurrency: 'USD',\n  timezone: 'UTC',\n  industry: 'fintech',\n\n  // === –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ===\n  sendTelegramForHot: true,\n  telegramChatId: '-1002588885971',\n\n  // === –°–†–û–ö–ò –ó–ê–ö–†–´–¢–ò–Ø –°–î–ï–õ–û–ö ===\n  closeDays: {\n    hot: 14,\n    warm: 30,\n    cold: 60\n  }\n};\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ + –¥–∞–Ω–Ω—ã–µ –∏–∑ webhook\nreturn [{\n  json: {\n    ...items[0].json,\n    CLIENT_CONFIG: CLIENT_CONFIG,\n    pipelineId: CLIENT_CONFIG.pipelineId\n  }\n}];"
      },
      "id": "9546e778-5b0a-419d-b2e2-0a9966c73f14",
      "name": "Set Client Config",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4384,
        304
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  wm.session_id,\n  wm.platform,\n  wm.message_count,\n  ucd.full_name,\n  ucd.first_name,\n  ucd.last_name,\n  ucd.phone,\n  ucd.email,\n  ucd.telegram,\n  ucd.whatsapp,\n  ucd.company,\n  ucd.position,\n  ucd.location,\n  da.emotional_tone,\n  da.customer_needs,\n  da.recommendations,\n  da.lead_scoring,\n  da.bant_qualification,\n  da.extracted_entities\nFROM webchat_monitoring wm\nLEFT JOIN user_contact_data ucd ON wm.session_id = ucd.session_id\nLEFT JOIN dialog_analysis da ON wm.session_id = da.session_id\nWHERE wm.session_id = '{{ $json.body.sessionId }}'\nLIMIT 1",
        "options": {}
      },
      "id": "9b67f8a2-5485-4773-9123-51f4c30cbb9e",
      "name": "Get Session Data",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -4176,
        304
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  CASE \n    WHEN message::json->>'type' = 'human' THEN 'human'\n    WHEN message::json->>'type' = 'ai' THEN 'ai'\n    ELSE 'system'\n  END as message_type,\n  COALESCE(\n    message::json->>'content',\n    message::json->>'text'\n  ) as content,\n  created_at\nFROM (\n  SELECT * FROM n8n_chat_histories_ru WHERE session_id = '{{ $('Get Session Data').item.json.session_id }}'\n  UNION ALL\n  SELECT * FROM n8n_chat_histories_en WHERE session_id = '{{ $('Get Session Data').item.json.session_id }}'\n) all_messages\nWHERE message IS NOT NULL\nORDER BY created_at ASC",
        "options": {}
      },
      "id": "6e2657e3-dfc4-46b2-b879-22520ed9fe0d",
      "name": "Get Dialog History",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -3968,
        304
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const webhook = $('Set Client Config').first().json;\nconst sessionData = $('Get Session Data').first().json;\nconst dialogHistory = $('Get Dialog History').all().map(item => item.json);\nconst stages = webhook.CLIENT_CONFIG.stages;\n\nreturn [{\n  json: {\n    webhook: webhook,\n    sessionData: sessionData,\n    dialogHistory: dialogHistory,\n    stages: stages,\n    CLIENT_CONFIG: webhook.CLIENT_CONFIG\n  }\n}];"
      },
      "id": "70f81087-9481-4e86-955b-5f8e55ca610d",
      "name": "Merge All Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3776,
        304
      ]
    },
    {
      "parameters": {
        "jsCode": "// –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –í–ï–†–°–ò–Ø - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç stages –∏–∑ CLIENT_CONFIG\n// –ù–ï —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö API –∑–∞–ø—Ä–æ—Å–æ–≤!\n\nconst CLIENT_CONFIG = items[0].json.CLIENT_CONFIG || {};\nconst startTime = Date.now();\nconst mergedData = items[0].json;\nconst requestData = mergedData.webhook;\nconst sessionId = requestData.body?.sessionId || requestData.sessionId || null;\nconst sessionData = mergedData.sessionData;\nconst dialogHistory = mergedData.dialogHistory;\nconst stages = mergedData.stages;\n\nlet leadScoring = {};\nlet bant = {};\nlet entities = {};\nlet customerNeeds = [];\nlet recommendations = [];\nlet emotionalTone = {};\n\ntry {\n  leadScoring = sessionData.lead_scoring ? \n    (typeof sessionData.lead_scoring === 'string' ? \n      JSON.parse(sessionData.lead_scoring) : sessionData.lead_scoring) : {};\n  \n  if (sessionData.bant_qualification) {\n    bant = typeof sessionData.bant_qualification === 'string' ? \n      JSON.parse(sessionData.bant_qualification) : sessionData.bant_qualification;\n  }\n  \n  if (sessionData.extracted_entities) {\n    entities = typeof sessionData.extracted_entities === 'string' ? \n      JSON.parse(sessionData.extracted_entities) : sessionData.extracted_entities;\n  }\n  \n  customerNeeds = sessionData.customer_needs ? \n    (typeof sessionData.customer_needs === 'string' ? \n      JSON.parse(sessionData.customer_needs) : sessionData.customer_needs) : [];\n  \n  recommendations = sessionData.recommendations ? \n    (typeof sessionData.recommendations === 'string' ? \n      JSON.parse(sessionData.recommendations) : sessionData.recommendations) : [];\n      \n  emotionalTone = sessionData.emotional_tone ?\n    (typeof sessionData.emotional_tone === 'string' ?\n      JSON.parse(sessionData.emotional_tone) : sessionData.emotional_tone) : {};\n} catch (e) {\n  console.error('Parse error:', e);\n}\n\nconst validateEmail = (email) => {\n  if (!email) return { valid: false, value: null };\n  const regex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return { valid: regex.test(email), value: email };\n};\n\nconst validatePhone = (phone) => {\n  if (!phone) return { valid: false, value: null };\n  const cleaned = phone.replace(/[^\\d+]/g, '');\n  return { valid: cleaned.length >= 10, value: cleaned };\n};\n\nconst emailData = entities?.contacts?.email?.value ? \n  validateEmail(entities.contacts.email.value) : validateEmail(sessionData.email);\n  \nconst phoneData = entities?.contacts?.phone?.value ? \n  validatePhone(entities.contacts.phone.value) : validatePhone(sessionData.phone);\n  \nconst telegram = entities?.contacts?.telegram?.value || sessionData.telegram || null;\nconst whatsapp = entities?.contacts?.whatsapp?.value || sessionData.whatsapp || null;\n\nconst firstName = entities?.person?.firstName || sessionData.first_name || '';\nconst lastName = entities?.person?.lastName || sessionData.last_name || '';\nconst fullName = entities?.person?.fullName || sessionData.full_name || \n  `${firstName} ${lastName}`.trim() || '–ö–ª–∏–µ–Ω—Ç –∏–∑ —á–∞—Ç–∞';\nconst companyName = entities?.organization?.companyName || sessionData.company || '';\nconst position = entities?.organization?.position || sessionData.position || '';\nconst location = entities?.location?.city || sessionData.location || '';\n\nconst leadScore = leadScoring?.score || 0;\nconst leadTemp = leadScoring?.temperature || 'cold';\nconst bantTotal = bant?.totalScore || 0;\nconst bantBudget = bant?.budget || {};\nconst bantNeed = bant?.need || {};\nconst bantAuthority = bant?.authority || {};\nconst bantTimeline = bant?.timeline || {};\n\n// –£–º–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞–¥–∏–∏\nfunction determineStage(leadTemp, stages, config) {\n  // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º custom mapping\n  const customStageId = config.stageMapping[leadTemp];\n  if (customStageId) {\n    const found = stages.find(s => s.id === customStageId);\n    if (found) {\n      return { stageId: found.id, stageName: found.name, method: 'custom' };\n    }\n  }\n  \n  // 2. –ü–æ–∏—Å–∫ –ø–æ keywords –≤ stages\n  for (const stage of stages) {\n    if (stage.keywords && Array.isArray(stage.keywords)) {\n      for (const keyword of stage.keywords) {\n        if (keyword.toLowerCase().includes(leadTemp.toLowerCase())) {\n          return { stageId: stage.id, stageName: stage.name, method: 'keyword' };\n        }\n      }\n    }\n  }\n  \n  // 3. Fallback - –±–µ—Ä–µ–º –ø–æ –ø–æ–∑–∏—Ü–∏–∏\n  const activeStages = stages.filter(s => s.type !== 1 && !s.isSuccess && !s.isClosed)\n    .sort((a, b) => (a.sort || 0) - (b.sort || 0));\n  \n  let fallbackStage;\n  if (leadTemp === 'hot') {\n    fallbackStage = activeStages[Math.min(Math.floor(activeStages.length * 0.6), activeStages.length - 1)];\n  } else if (leadTemp === 'warm') {\n    fallbackStage = activeStages[Math.min(Math.floor(activeStages.length * 0.4), activeStages.length - 1)];\n  } else {\n    fallbackStage = activeStages[0];\n  }\n  \n  return { stageId: fallbackStage.id, stageName: fallbackStage.name, method: 'fallback' };\n}\n\nconst stageResult = determineStage(leadTemp, stages, CLIENT_CONFIG);\n\nlet opportunityAmount = 0;\nif (bantBudget?.value && bantBudget.value > 0) {\n  opportunityAmount = bantBudget.value;\n} else if (bantBudget?.range?.min && bantBudget.range.min > 0) {\n  opportunityAmount = bantBudget.range.min;\n}\n\nconst customFieldsValues = [];\n\nif (phoneData.valid) {\n  customFieldsValues.push({\n    field_id: CLIENT_CONFIG.customFields.phone,\n    values: [{\n      value: phoneData.value,\n      enum_id: CLIENT_CONFIG.phoneEnums.WORK\n    }]\n  });\n}\n\nif (emailData.valid) {\n  customFieldsValues.push({\n    field_id: CLIENT_CONFIG.customFields.email,\n    values: [{\n      value: emailData.value,\n      enum_id: CLIENT_CONFIG.emailEnums.WORK\n    }]\n  });\n}\n\nif (position) {\n  customFieldsValues.push({\n    field_id: CLIENT_CONFIG.customFields.position,\n    values: [{\n      value: position\n    }]\n  });\n}\n\nconst closeDays = CLIENT_CONFIG.closeDays[leadTemp] || 60;\nconst closeDate = new Date();\ncloseDate.setDate(closeDate.getDate() + closeDays);\nconst closeDateUnix = Math.floor(closeDate.getTime() / 1000);\n\nconst utmData = {\n  source: sessionData.utm_source || 'direct',\n  medium: sessionData.utm_medium || 'none',\n  campaign: sessionData.utm_campaign || 'organic'\n};\n\nconst aiCommentInput = {\n  leadScore: leadScore,\n  leadTemperature: leadTemp,\n  bantTotal: bantTotal,\n  bantQualified: bant?.qualified || false,\n  bant: {\n    budget: {\n      score: bantBudget?.score || 0,\n      description: bantBudget?.description || '–ù–µ —É–∫–∞–∑–∞–Ω',\n      value: bantBudget?.value || null,\n      mentioned: bantBudget?.mentioned || false\n    },\n    authority: {\n      score: bantAuthority?.score || 0,\n      role: bantAuthority?.role || 'unknown',\n      level: bantAuthority?.level || 'unknown',\n      description: bantAuthority?.description || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ'\n    },\n    need: {\n      score: bantNeed?.score || 0,\n      severity: bantNeed?.severity || 'unknown',\n      painPoints: bantNeed?.painPoints || [],\n      description: bantNeed?.description || '–ù–µ –≤—ã—è–≤–ª–µ–Ω–æ'\n    },\n    timeline: {\n      score: bantTimeline?.score || 0,\n      urgency: bantTimeline?.urgency || 'unknown',\n      deadline: bantTimeline?.deadline || null,\n      description: bantTimeline?.description || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'\n    }\n  },\n  customerProfile: {\n  name: fullName,\n  company: companyName,\n  position: position || '',     // ‚Üê –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –µ—Å–ª–∏ null\n  location: location || '',\n  email: emailData.value || '', // ‚Üê –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –µ—Å–ª–∏ null\n  phone: phoneData.value || ''  // ‚Üê –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –µ—Å–ª–∏ null\n},\n  customerNeeds: customerNeeds,\n  painPoints: bantNeed?.painPoints || [],\n  emotionalTone: {\n    overall: emotionalTone?.overall || 'neutral',\n    satisfaction: emotionalTone?.satisfaction || 50,\n    description: emotionalTone?.description || ''\n  },\n  recommendations: recommendations,\n  productsInterested: entities?.products || [],\n  currentSolution: entities?.currentSolution || {},\n  competitors: entities?.competitors || [],\n  dialogHistory: dialogHistory.map(msg => ({\n    role: msg.message_type,\n    content: msg.content?.substring(0, 200) || ''\n  })),\n  messageCount: sessionData.message_count || dialogHistory.length,\n  platform: sessionData.platform || 'webchat',\n  utmData: utmData,\n  industry: CLIENT_CONFIG.industry,\n  stageName: stageResult.stageName,\n  opportunityAmount: opportunityAmount,\n  currency: CLIENT_CONFIG.defaultCurrency,\n  priceList: CLIENT_CONFIG.priceList\n};\n\nreturn [{\n  json: {\n    clientName: CLIENT_CONFIG.clientName,\n    sessionId: sessionId,\n    leadScore: leadScore,\n    leadTemperature: leadTemp,\n    bantScore: bantTotal,\n    bantQualified: bant?.qualified || false,\n    bantLevel: bant?.qualificationLevel || 'cold',\n    stageId: stageResult.stageId,\n    stageName: stageResult.stageName,\n    pipelineId: CLIENT_CONFIG.pipelineId,\n    pipelineName: CLIENT_CONFIG.pipelineName,\n    isHotLead: leadScore >= 70,\n    responsibleUserId: requestData.assignedManager || CLIENT_CONFIG.defaultManagerId,\n    subdomain: CLIENT_CONFIG.subdomain,\n    sendTelegram: CLIENT_CONFIG.sendTelegramForHot && leadScore >= 70,\n    telegramChatId: CLIENT_CONFIG.telegramChatId,\n    contact: {\n      name: fullName,\n      first_name: firstName,\n      last_name: lastName,\n      custom_fields_values: customFieldsValues,\n      responsible_user_id: requestData.assignedManager || CLIENT_CONFIG.defaultManagerId\n    },\n    lead: {\n      name: `ü§ñ ${fullName} | Score: ${leadScore}${companyName ? ' | ' + companyName : ''}`,\n      pipeline_id: CLIENT_CONFIG.pipelineId,\n      status_id: stageResult.stageId,\n      price: opportunityAmount,\n      responsible_user_id: requestData.assignedManager || CLIENT_CONFIG.defaultManagerId,\n      created_by: requestData.assignedManager || CLIENT_CONFIG.defaultManagerId,\n      updated_by: requestData.assignedManager || CLIENT_CONFIG.defaultManagerId,\n      closed_at: closeDateUnix\n    },\n    searchData: (() => {\n  const data = {};\n  if (phoneData.valid && phoneData.value) {\n    data.phone = phoneData.value;\n  }\n  if (emailData.valid && emailData.value) {\n    data.email = emailData.value;\n  }\n  return data;\n})(),\n    validation: {\n      hasEmail: emailData.valid,\n      hasPhone: phoneData.valid,\n      hasName: !!fullName,\n      isValid: emailData.valid || phoneData.valid,\n      missingFields: [\n        !emailData.valid && !phoneData.valid ? 'contact' : null,\n        !fullName ? 'name' : null\n      ].filter(Boolean)\n    },\n    utmData: utmData,\n    aiCommentInput: aiCommentInput,\n    startTime: startTime,\n    CLIENT_CONFIG: CLIENT_CONFIG\n  }\n}];"
      },
      "id": "a5415e80-84c2-434a-b304-1b2d9afc9c06",
      "name": "Format Data (Optimized)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3584,
        304
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# –ó–ê–î–ê–ß–ê: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è CRM\n\n## –í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï:\n\n### Lead Qualification:\n- Lead Score: {{ $json.aiCommentInput.leadScore }}/100\n- Temperature: {{ $json.aiCommentInput.leadTemperature }}\n- BANT Score: {{ $json.aiCommentInput.bantTotal }}/70\n- Qualified: {{ $json.aiCommentInput.bantQualified }}\n\n### BANT:\n**Budget:** {{ $json.aiCommentInput.bant.budget.description }}\n**Authority:** {{ $json.aiCommentInput.bant.authority.description }}\n**Need:** {{ $json.aiCommentInput.bant.need.description }}\n**Timeline:** {{ $json.aiCommentInput.bant.timeline.description }}\n\n### Customer:\n- Name: {{ $json.aiCommentInput.customerProfile.name }}\n- Company: {{ $json.aiCommentInput.customerProfile.company || '–ù–µ —É–∫–∞–∑–∞–Ω–∞' }}\n- Email: {{ $json.aiCommentInput.customerProfile.email }}\n- Phone: {{ $json.aiCommentInput.customerProfile.phone || '–ù–µ—Ç' }}\n\n### Needs:\n{{ JSON.stringify($json.aiCommentInput.customerNeeds) }}\n\n### Emotional Tone:\n- Overall: {{ $json.aiCommentInput.emotionalTone.overall }}\n- Satisfaction: {{ $json.aiCommentInput.emotionalTone.satisfaction }}%\n\n### Dialog:\nTotal Messages: {{ $json.aiCommentInput.messageCount }}\nLast 5:\n{{ $json.aiCommentInput.dialogHistory.slice(-5).map(m => `${m.role === 'human' ? '–ö–ª–∏–µ–Ω—Ç' : 'AI'}: ${m.content}`).join('\\n') }}\n\n### Context:\n- Platform: {{ $json.aiCommentInput.platform }}\n- UTM: {{ $json.aiCommentInput.utmData.source }}/{{ $json.aiCommentInput.utmData.medium }}\n- Client: {{ $json.clientName }}\n- Industry: {{ $json.aiCommentInput.industry }}\n- Stage: {{ $json.aiCommentInput.stageName }}\n\n---\n\n–°–æ–∑–¥–∞–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–ª–µ–¥—É—è —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∏–∑ System Message. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤—å JSON –±–ª–æ–∫ —Å –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–º–∏ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏ –∏ —Ü–µ–Ω–∞–º–∏ –≤ –∫–æ–Ω—Ü–µ.",
        "messages": {
          "messageValues": [
            {
              "message": "=–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –ª–∏–¥–æ–≤ –∏ CRM. –°–æ–∑–¥–∞–≤–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ, actionable –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏, –±—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º, —Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è—Ö. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 250-400 —Å–ª–æ–≤.\n\n## –ö–†–ò–¢–ò–ß–ù–ê–Ø –ó–ê–î–ê–ß–ê - –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –ü–†–û–î–£–ö–¢–û–í –ò –¶–ï–ù:\n\n–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –í–ï–°–¨ –¥–∏–∞–ª–æ–≥ –∏ –Ω–∞–π–¥–∏:\n\n### 1. –õ–Æ–ë–´–ï —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤/—Ç–∞—Ä–∏—Ñ–æ–≤:\n- –ù–∞–∑–≤–∞–Ω–∏—è –ø–ª–∞–Ω–æ–≤: \"starter\", \"basic\", \"premium\", \"pro\"\n- –†—É—Å—Å–∫–∏–µ –∞–Ω–∞–ª–æ–≥–∏: \"—Å—Ç–∞—Ä—Ç–æ–≤—ã–π\", \"–±–∞–∑–æ–≤—ã–π\", \"–Ω–∞—á–∞–ª—å–Ω—ã–π\"\n- –§—Ä–∞–∑—ã: \"–Ω–∞—á–Ω—É —Å–æ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ\", \"—Ö–æ—á—É –±–∞–∑–æ–≤—ã–π –ø–∞–∫–µ—Ç\"\n\n### 2. –¶–ï–ù–´ (—Ç–æ—á–Ω—ã–µ –∏–ª–∏ –∫–æ—Å–≤–µ–Ω–Ω—ã–µ):\n\n**–¢–û–ß–ù–´–ï —Ü–µ–Ω—ã –∏–∑ –¥–∏–∞–ª–æ–≥–∞:**\n- –õ—é–±–∞—è —Å—É–º–º–∞ —Å –ø–µ—Ä–∏–æ–¥–æ–º: \"500 —Ä—É–±–ª–µ–π/–º–µ—Å—è—Ü\" ‚Üí \"500 RUB/month\"\n- –õ—é–±–∞—è —Å—É–º–º–∞ —Å –ø–µ—Ä–∏–æ–¥–æ–º: \"2000 BGN –≤ –≥–æ–¥\" ‚Üí \"2000 BGN/year\"\n- –õ—é–±–∞—è —Å—É–º–º–∞ —Å –≤–∞–ª—é—Ç–æ–π: \"$100\", \"‚Ç¨50\", \"1000 —Ä—É–±\" ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å\n- –°—É–º–º–∞ –ë–ï–ó –≤–∞–ª—é—Ç—ã: \"5000 –∑–∞ –º–µ—Å—è—Ü\" ‚Üí \"5000/month\"\n\n**–ö–û–°–í–ï–ù–ù–´–ï —Ü–µ–Ω—ã (–∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞):**\n- –ï—Å–ª–∏ AI –Ω–∞–∑–≤–∞–ª —Ü–µ–Ω—É ‚Üí –∫–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–∏–ª—Å—è (\"–ì–æ—Ç–æ–≤\", \"–ë–µ—Ä—É\", \"–ù–∞—á–Ω—É —Å —ç—Ç–æ–≥–æ\") ‚Üí –∏–∑–≤–ª–µ–∫–∞–π –≠–¢–£ —Ü–µ–Ω—É\n- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–æ—Å–∏–ª \"–°–∫–æ–ª—å–∫–æ?\" ‚Üí AI –æ—Ç–≤–µ—Ç–∏–ª —Å —Ü–∏—Ñ—Ä–æ–π ‚Üí –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ–¥–æ–ª–∂–∏–ª –¥–∏–∞–ª–æ–≥ –ø–æ–∑–∏—Ç–∏–≤–Ω–æ ‚Üí –∏–∑–≤–ª–µ–∫–∞–π\n\n**–§–û–†–ú–ê–¢ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è:**\n- –°–æ—Ö—Ä–∞–Ω—è–π –¢–û–ß–ù–û –∫–∞–∫ –≤ –¥–∏–∞–ª–æ–≥–µ: \"2000 BGN/–º–µ—Å—è—Ü\", \"$99\", \"15000 —Ä—É–±–ª–µ–π\"\n- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ü–µ–Ω—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ –±—ã–ª–æ\n- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏–º–µ—Ä–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è\n- –ï—Å–ª–∏ —Ü–µ–Ω—ã –ù–ï–¢ –≤ –¥–∏–∞–ª–æ–≥–µ ‚Üí mentionedPrices = []\n\n---\n\n## –í–ê–ñ–ù–û - –õ–û–ì–ò–ö–ê –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø:\n\n‚úÖ **–ï–°–õ–ò –∫–ª–∏–µ–Ω—Ç —É–ø–æ–º—è–Ω—É–ª –ø—Ä–æ–¥—É–∫—Ç** (–Ω–∞–ø—Ä–∏–º–µ—Ä \"–Ω–∞—á–Ω—É —Å–æ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ\"):\n- –ü—Ä–æ–≤–µ—Ä—å –í–ï–°–¨ –¥–∏–∞–ª–æ–≥ - –Ω–∞–∑—ã–≤–∞–ª –ª–∏ AI —Ü–µ–Ω—É —ç—Ç–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞?\n- –ï—Å–ª–∏ –î–ê ‚Üí –¥–æ–±–∞–≤—å —Ü–µ–Ω—É –≤ mentionedPrices\n- –ï—Å–ª–∏ –ù–ï–¢ ‚Üí –æ—Å—Ç–∞–≤—å mentionedPrices –ø—É—Å—Ç—ã–º\n\n‚úÖ **–ï–°–õ–ò –∫–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–∏–ª—Å—è –∫—É–ø–∏—Ç—å** (\"–î–∞ –≥–æ—Ç–æ–≤\", \"–ù–∞—á–Ω—É —Å —ç—Ç–æ–≥–æ\"):\n- –ü–æ—Å–º–æ—Ç—Ä–∏, —á—Ç–æ AI –ø—Ä–µ–¥–ª–∞–≥–∞–ª –ü–ï–†–ï–î —ç—Ç–∏–º\n- –ï—Å–ª–∏ AI –Ω–∞–∑–≤–∞–ª —Ü–µ–Ω—É/–ø—Ä–æ–¥—É–∫—Ç ‚Üí –∏–∑–≤–ª–µ–∫–∏ –∏—Ö!\n\n‚úÖ **–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø:**\n\n–î–∏–∞–ª–æ–≥ 1:\n- AI: \"–¢–∞—Ä–∏—Ñ Starter –∑–∞ $29/–º–µ—Å—è—Ü\"\n- –ö–ª–∏–µ–Ω—Ç: \"–ù–∞–≤–µ—Ä–Ω–æ–µ –Ω–∞—á–Ω—É —Å–æ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ\"\n‚Üí mentionedProducts: [\"starter\"], mentionedPrices: [\"$29/month\"]\n\n–î–∏–∞–ª–æ–≥ 2:\n- AI: \"–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å—Ç–æ–∏—Ç $99\"\n- –ö–ª–∏–µ–Ω—Ç: \"–•–æ—Ä–æ—à–æ, –≥–æ—Ç–æ–≤\"\n‚Üí mentionedProducts: [\"–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è\"], mentionedPrices: [\"$99\"]\n\n–î–∏–∞–ª–æ–≥ 3:\n- –ö–ª–∏–µ–Ω—Ç: \"–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç?\"\n- AI: \"–¶–µ–Ω—ã –Ω–∞ —Å–∞–π—Ç–µ\"\n- –ö–ª–∏–µ–Ω—Ç: \"–û–∫, –ø–æ—Å–º–æ—Ç—Ä—é\"\n‚Üí mentionedProducts: [], mentionedPrices: []\n\n---\n\n## –ö–†–ò–¢–ò–ß–ù–û - –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï JSON:\n\n–í –°–ê–ú–û–ú –ö–û–ù–¶–ï –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è (–ø–æ—Å–ª–µ –≤—Å–µ—Ö —Ä–∞–∑–¥–µ–ª–æ–≤) –¥–æ–±–∞–≤—å –ß–ò–°–¢–´–ô JSON –±–ª–æ–∫ –ë–ï–ó markdown:\n\n**–ï–°–õ–ò —á—Ç–æ-—Ç–æ –Ω–∞–π–¥–µ–Ω–æ:**\n{\n  \"mentionedProducts\": [\"starter\"],\n  \"mentionedPrices\": [\"$29/month\"],\n  \"billingPeriod\": \"monthly\",\n  \"confidence\": \"high\"\n}\n\n**–ï–°–õ–ò –Ω–∏—á–µ–≥–æ –ù–ï –Ω–∞–π–¥–µ–Ω–æ:**\n{\n  \"mentionedProducts\": [],\n  \"mentionedPrices\": [],\n  \"billingPeriod\": null,\n  \"confidence\": \"none\"\n}\n\n‚ùå –ù–ï –æ–±–æ—Ä–∞—á–∏–≤–∞–π –≤ ```json``` –∏–ª–∏ ```\n‚ùå –ù–ï –¥–æ–±–∞–≤–ª—è–π –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã\n‚úÖ –ü—Ä–æ—Å—Ç–æ —á–∏—Å—Ç—ã–π JSON –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –∏–ª–∏ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏\n\n---\n\n## –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –ö–û–ú–ú–ï–ù–¢–ê–†–ò–Ø (–ë–ï–ó MARKDOWN –ö–û–î-–ë–õ–û–ö–û–í):\n\n–ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û:\n- –≠–º–æ–¥–∑–∏\n- –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç (**—Ç–µ–∫—Å—Ç**)\n- –°–ø–∏—Å–∫–∏ (‚Ä¢ –∏–ª–∏ 1Ô∏è‚É£, 2Ô∏è‚É£, 3Ô∏è‚É£)\n\n‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π: ```code```, `backticks`, markdown –±–ª–æ–∫–∏\n\n–°—Ç—Ä—É–∫—Ç—É—Ä–∞:\n\nüéØ EXECUTIVE SUMMARY\n[2-3 —Å—Ç—Ä–æ–∫–∏ - —Å—É—Ç—å]\n\nüìä QUALIFICATION\nüî• Lead Score: X/100 (TEMPERATURE)\nüìã BANT: X/70\n\nüí° KEY INSIGHTS\n-  [–ò–Ω—Å–∞–π—Ç 1]\n-  [–ò–Ω—Å–∞–π—Ç 2]\n-  [–ò–Ω—Å–∞–π—Ç 3]\n\nüë§ CUSTOMER PROFILE\nüí∞ Budget: [–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è]\n‚ö° Urgency: [—É—Ä–æ–≤–µ–Ω—å]\nüéØ Pain Points: [—Å–ø–∏—Å–æ–∫]\nüéÅ Needs: [—Å–ø–∏—Å–æ–∫]\n\nüöÄ NEXT STEPS (–ü–†–ò–û–†–ò–¢–ï–¢)\n1Ô∏è‚É£ [–î–µ–π—Å—Ç–≤–∏–µ 1]\n2Ô∏è‚É£ [–î–µ–π—Å—Ç–≤–∏–µ 2]\n\n‚ö†Ô∏è IMPORTANT NOTES\n-  [–í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è]\n\nüí¨ CONVERSATION SUMMARY\n[–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ]\n\nüìå METADATA\nüåê UTM: source/medium\nüí¨ Platform: X\n\n{\n  \"mentionedProducts\": [\"...\"],\n  \"mentionedPrices\": [\"...\"],\n  \"billingPeriod\": \"...\",\n  \"confidence\": \"...\"\n}"
            }
          ]
        }
      },
      "id": "02d86abf-f9ba-483c-a919-1057da238137",
      "name": "Generate AI Comment",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.4,
      "position": [
        -3392,
        304
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "f3d87a85-bf5f-4b56-a682-214f884915e2",
      "name": "Google Gemini Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -3440,
        496
      ],
      "credentials": {
        "googlePalmApi": {
          "id": "abo0BDHSJPM0pgRU",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ê–î–ê–ü–¢–ò–†–û–í–ê–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –î–õ–Ø kommoCRM (–∫–∞–∫ –≤ Bitrix24)\nconst formattedData = $('Format Data (Optimized)').first().json;\nconst agentResponse = $('Generate AI Comment').first().json;\n\n// üîç –ò–ó–í–õ–ï–ß–ï–ù–ò–ï AI –ö–û–ú–ú–ï–ù–¢–ê–†–ò–Ø (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤)\nlet aiComment = '';\nif (agentResponse.output) {\n  aiComment = agentResponse.output;\n} else if (agentResponse.text) {\n  aiComment = agentResponse.text;\n} else if (agentResponse.response) {\n  aiComment = agentResponse.response;\n} else {\n  aiComment = JSON.stringify(agentResponse);\n}\n\nconsole.log('AI Comment extracted, length:', aiComment.length);\n\n// üßπ –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –¥–ª—è kommoCRM API (–° –°–û–•–†–ê–ù–ï–ù–ò–ï–ú –°–¢–†–£–ö–¢–£–†–´)\naiComment = aiComment\n  // –£–¥–∞–ª–∏—Ç—å —Å–ª—É–∂–µ–±–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç AI\n  .replace(/###?\\s*–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è CRM[\\s\\S]*?(?=\\n\\*\\*)/i, '')\n  .replace(/–û–ü–¢–ò–ú–ê–õ–¨–ù–´–ô –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô –î–õ–Ø CRM/gi, '')\n  \n  // –£–¥–∞–ª–∏—Ç—å code blocks\n  .replace(/```[\\s\\S]*?```/g, '')\n  .replace(/```/g, '')\n  .replace(/`{1,2}([^`]+)`{1,2}/g, '$1')\n  \n  // –£–î–ê–õ–ò–¢–¨ –í–°–ï –≠–ú–û–î–ó–ò –ò –°–ü–ï–¶–°–ò–ú–í–û–õ–´\n  .replace(/[\\u{1F300}-\\u{1F9FF}]/gu, '')\n  .replace(/[\\u{2600}-\\u{26FF}]/gu, '')\n  .replace(/[\\u{2700}-\\u{27BF}]/gu, '')\n  .replace(/[\\u{1F600}-\\u{1F64F}]/gu, '')\n  .replace(/[\\u{1F680}-\\u{1F6FF}]/gu, '')\n  .replace(/[\\u{1F1E0}-\\u{1F1FF}]/gu, '')\n  .replace(/[üéØüî•üìäüí°‚ö°üö®‚úÖ‚ùå‚è≥üí∞üìåüå°Ô∏è‚ùÑÔ∏èüë§üí¨üè¢üìß‚òéÔ∏èüìçüéÅüîç‚ö†Ô∏èüìùüè≠üåêü§ùüõ°Ô∏èüöÄ‚ú®üßë‚Äçüíªü§ñüíª‚≠ê‚ô¶Ô∏è‚óÜ‚óè]/g, '')\n  .replace(/[‚óÜ‚óè‚ô¶‚óá‚óã‚ñ†‚ñ°‚ñ™‚ñ´]/g, '')\n  \n  // –£–î–ê–õ–ò–¢–¨ –î–£–ë–õ–ò–†–£–Æ–©–ò–ï–°–Ø –ë–õ–û–ö–ò\n  .replace(/IMPORTANT NOTES[\\s\\S]*?(?=CONVERSATION SUMMARY|METADATA|$)/i, '')\n  .replace(/CONVERSATION SUMMARY[\\s\\S]*?(?=METADATA|$)/i, '')\n  \n  // –£–¥–∞–ª–∏—Ç—å markdown\n  .replace(/^#+\\s*/gm, '')\n  .replace(/\\*\\*/g, '')\n  .replace(/---/g, '')\n  .replace(/===/g, '')\n  \n  // –û—á–∏—Å—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã\n  .replace(/\\\\n/g, '\\n')\n  .replace(/\\\\u[0-9a-fA-F]{4}/g, '')\n  \n  // –û—á–∏—Å—Ç–∏—Ç—å –¢–û–õ–¨–ö–û –ª–∏—à–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å—ã\n  .replace(/\\n{3,}/g, '\\n\\n')\n  \n  // –û—á–∏—Å—Ç–∏—Ç—å –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã\n  .replace(/ +/g, ' ')\n  .replace(/\\n /g, '\\n')\n  .replace(/ \\n/g, '\\n')\n  \n  .trim();\n\nconsole.log('AI Comment after cleanup, length:', aiComment.length);\n\n// ‚ö†Ô∏è CRITICAL CHECK - –µ—Å–ª–∏ aiComment –ø—É—Å—Ç–æ–π –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏\nif (!aiComment || aiComment.length < 50) {\n  console.log('üö® WARNING: AI Comment too short, restoring from original');\n  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –±–µ–∑ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏\n  aiComment = (agentResponse.output || agentResponse.text || agentResponse.response || '')\n    .replace(/```[\\s\\S]*?```/g, '')\n    .replace(/[üéØüî•üìäüí°‚ö°üö®‚úÖ‚ùå‚è≥üí∞üìåüå°Ô∏è‚ùÑÔ∏èüë§üí¨üè¢üìß‚òéÔ∏èüìçüéÅüîç‚ö†Ô∏èüìùüè≠üåêü§ùüõ°Ô∏èüöÄ‚ú®üßë‚Äçüíªü§ñüíª‚≠ê‚ô¶Ô∏è‚óÜ‚óè]/g, '')\n    .replace(/\\*\\*/g, '')\n    .trim();\n}\n\n// üîç –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• –û –ü–†–û–î–£–ö–¢–ê–• –ò–ó AI-–û–¢–í–ï–¢–ê\nlet extractedData = null;\nconst jsonMatch = aiComment.match(/\\{[\\s\\S]*?\"mentionedProducts\"[\\s\\S]*?\\}/);\nif (jsonMatch) {\n  try {\n    extractedData = JSON.parse(jsonMatch[0]);\n    aiComment = aiComment.replace(jsonMatch[0], '').trim();\n  } catch (e) {\n    console.log('Could not parse extracted product data:', e);\n  }\n}\n\n// üí∞ –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –†–ê–°–ß–ï–¢ OPPORTUNITY\nconst PRICE_LIST = formattedData.CLIENT_CONFIG?.priceList || {};\nconst OPPORTUNITY_MODE = formattedData.CLIENT_CONFIG?.opportunityMode || 'smart';\n\nlet opportunityAmount = formattedData.opportunityAmount || 0;\nlet opportunityNote = '';\nlet opportunitySource = 'none';\nlet billingPeriod = 'unknown';\n\n// üìä –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ï—Å–ª–∏ —É–∂–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω\nif (opportunityAmount > 0) {\n  opportunitySource = 'pre_calculated';\n  console.log('Using pre-calculated opportunity:', opportunityAmount);\n}\n\n// üìä –ü–†–ò–û–†–ò–¢–ï–¢ 2: –¢–û–ß–ù–ê–Ø –¶–ï–ù–ê –ò–ó –î–ò–ê–õ–û–ì–ê\nif (opportunityAmount === 0 && extractedData?.mentionedPrices?.length > 0) {\n  const priceString = extractedData.mentionedPrices[0].toLowerCase();\n  const numberMatch = priceString.match(/\\$?(\\d+(?:,\\d{3})*(?:\\.\\d{2})?)/);\n  \n  if (numberMatch) {\n    const priceValue = parseFloat(numberMatch[1].replace(/,/g, ''));\n    \n    if (priceString.includes('month') || priceString.includes('–º–µ—Å') || priceString.includes('/mo')) {\n      opportunityAmount = priceValue;\n      billingPeriod = 'monthly';\n      opportunityNote = `Client mentioned: $${priceValue}/month`;\n      opportunitySource = 'dialog_price_monthly';\n      \n    } else if (priceString.includes('year') || priceString.includes('–≥–æ–¥') || priceString.includes('annual')) {\n      opportunityAmount = priceValue;\n      billingPeriod = 'annual';\n      opportunityNote = `Client mentioned: $${priceValue}/year`;\n      opportunitySource = 'dialog_price_annual';\n      \n    } else {\n      opportunityAmount = priceValue;\n      billingPeriod = 'unspecified';\n      opportunityNote = `Client mentioned: $${priceValue}`;\n      opportunitySource = 'dialog_price';\n    }\n    \n    console.log(`‚úÖ EXACT price from dialog: $${opportunityAmount}`);\n  }\n}\n\n// üìä –ü–†–ò–û–†–ò–¢–ï–¢ 3: –ü–†–û–î–£–ö–¢ + –ü–†–ê–ô–°-–õ–ò–°–¢\nif (opportunityAmount === 0 && \n    (OPPORTUNITY_MODE === 'smart' || OPPORTUNITY_MODE === 'estimate') &&\n    extractedData?.mentionedProducts?.length > 0 && \n    Object.keys(PRICE_LIST).length > 0) {\n  \n  const mentionedProduct = extractedData.mentionedProducts[0].toLowerCase();\n  \n  for (const [productKey, productData] of Object.entries(PRICE_LIST)) {\n    const keywords = productData.keywords || [productKey];\n    const isMatch = keywords.some(kw => mentionedProduct.includes(kw.toLowerCase()));\n    \n    if (isMatch) {\n      const defaultBilling = productData.defaultBilling || 'monthly';\n      \n      if (defaultBilling === 'monthly') {\n        opportunityAmount = productData.monthly;\n        billingPeriod = 'monthly';\n        opportunityNote = `${productData.display}: $${productData.monthly}/month (from price list)`;\n      } else {\n        opportunityAmount = productData.annual;\n        billingPeriod = 'annual';\n        opportunityNote = `${productData.display}: $${productData.annual}/year (from price list)`;\n      }\n      \n      opportunitySource = 'price_list';\n      console.log(`‚úÖ Product from price list: $${opportunityAmount}`);\n      break;\n    }\n  }\n}\n\n// üìä –ü–†–ò–û–†–ò–¢–ï–¢ 4: BANT –ë–Æ–î–ñ–ï–¢\nif (opportunityAmount === 0) {\n  const bantBudget = formattedData.aiCommentInput?.bant?.budget;\n  \n  if (bantBudget?.value && bantBudget.value > 0) {\n    opportunityAmount = bantBudget.value;\n    billingPeriod = 'unspecified';\n    opportunityNote = `BANT budget analysis: $${opportunityAmount}`;\n    opportunitySource = 'bant_budget';\n    console.log(`‚úÖ BANT budget: $${opportunityAmount}`);\n  }\n}\n\n// üìä –ü–†–ò–û–†–ò–¢–ï–¢ 5: –°–†–ï–î–ù–ò–ô –ß–ï–ö –ü–û –¢–ï–ú–ü–ï–†–ê–¢–£–†–ï (smart mode)\nif (opportunityAmount === 0 && OPPORTUNITY_MODE === 'smart') {\n  const leadTemp = formattedData.leadTemperature;\n  const averageDeals = formattedData.CLIENT_CONFIG?.averageDeals || {};\n  \n  opportunityAmount = averageDeals[leadTemp] || averageDeals.cold || 0;\n  billingPeriod = 'estimated';\n  opportunityNote = `Estimated based on lead temperature: ${leadTemp}`;\n  opportunitySource = 'average_deal';\n  console.log(`‚úÖ Average deal for ${leadTemp}: $${opportunityAmount}`);\n}\n\n// üìä –§–ò–ù–ê–õ: –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ\nif (opportunityAmount === 0) {\n  opportunityNote = 'No pricing information available - to be determined by manager';\n  opportunitySource = 'none';\n  console.log(`‚ö†Ô∏è No opportunity data found ‚Üí $0`);\n}\n\n// ‚úÖ –û–ë–ù–û–í–õ–Ø–ï–ú LEAD PRICE\nconst updatedLead = {\n  ...(formattedData.lead || {}),\n  price: opportunityAmount\n};\n\n// üìä –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –î–õ–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ò\nconst opportunityCalculation = {\n  amount: opportunityAmount,\n  billingPeriod: billingPeriod,\n  note: opportunityNote,\n  source: opportunitySource,\n  mode: OPPORTUNITY_MODE,\n  extractedData: extractedData\n};\n\n// üìù –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê\nconsole.log('=== FINAL CHECK ===');\nconsole.log('AI Comment length:', aiComment.length);\nconsole.log('Opportunity Amount:', opportunityAmount);\nconsole.log('==================');\n\n// ‚ö†Ô∏è CRITICAL: –£–±–µ–¥–∏—Å—å —á—Ç–æ aiComment –ù–ï –ø—É—Å—Ç–æ–π\nif (!aiComment || aiComment.trim().length === 0) {\n  console.log('üö® CRITICAL ERROR: AI Comment is EMPTY!');\n  aiComment = `Lead Score: ${formattedData.leadScore}/100 (${formattedData.leadTemperature})\\nBANT: ${formattedData.bantScore}/70\\nOpportunity: ${opportunityAmount}\\n\\n[AI Comment generation failed - please review manually]`;\n}\n\n// –í–û–ó–í–†–ê–©–ê–ï–ú –û–ë–ù–û–í–õ–Å–ù–ù–´–ï –î–ê–ù–ù–´–ï\nreturn [{\n  json: {\n    ...formattedData,\n    lead: updatedLead,\n    aiComment: aiComment, // ‚Üê –í–°–ï–ì–î–ê –ó–ê–ü–û–õ–ù–ï–ù\n    opportunityAmount: opportunityAmount,\n    opportunityCalculation: opportunityCalculation,\n    commentAdded: true\n  }\n}];"
      },
      "id": "1d648bdd-ef27-4244-aa24-4c743c70efa6",
      "name": "Update Deal with AI Comment",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3008,
        304
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.validation.isValid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              },
              "id": "validation-check"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "3e626144-6f0a-4c7b-80de-35a1cc04b3a2",
      "name": "Validate Data",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -2784,
        304
      ]
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –∏–∑ –Ω–æ–≤–æ–≥–æ —É–∑–ª–∞\nconst searchResult = $('Get list of contacts').first().json;\nconst formatData = $('Update Deal with AI Comment').first().json;\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤\nconst contacts = searchResult._embedded?.contacts || [];\n\nlet contactExists = false;\nlet existingContactId = null;\n\nif (contacts.length > 0) {\n  contactExists = true;\n  existingContactId = contacts[0].id;\n  console.log('‚úÖ Contact found:', existingContactId);\n} else {\n  console.log('‚ùå Contact not found, will create new');\n}\n\nreturn [{\n  json: {\n    ...formatData,\n    contactExists: contactExists,\n    existingContactId: existingContactId,\n    searchResults: contacts\n  }\n}];"
      },
      "id": "5001946f-d3cb-4fbb-a64a-c30d1b4f2d17",
      "name": "Check Contact",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2320,
        288
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.contactExists }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              },
              "id": "contact-exists-check"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "2cd7822a-5bba-432d-bfa5-92ed9823431c",
      "name": "If Contact Exists",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -2128,
        288
      ]
    },
    {
      "parameters": {
        "jsCode": "// –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —É–∑–ª–æ–º Merge\n\n// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —É–∑–ª–æ–≤\nconst mergedResult = items[0].json; // –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç Merge (Update –∏–ª–∏ Create)\nconst checkContactData = $('Check Contact').first().json; // –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–ª–∏ –¥–∞–Ω–Ω—ã–µ –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º contactId\nlet contactId;\nlet contactAction;\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞ –æ—Ç kommoCRM\nif (mergedResult._embedded?.contacts?.[0]?.id) {\n  // –ü—Ä–∏—à–ª–∏ –¥–∞–Ω–Ω—ã–µ –æ—Ç Update Contact –∏–ª–∏ Create Contact\n  contactId = mergedResult._embedded.contacts[0].id;\n  \n  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ - –µ—Å–ª–∏ existingContactId –µ—Å—Ç—å, –∑–Ω–∞—á–∏—Ç update\n  if (checkContactData.existingContactId) {\n    contactAction = 'updated';\n  } else {\n    contactAction = 'created';\n  }\n} else if (checkContactData.existingContactId) {\n  // Fallback - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π ID\n  contactId = checkContactData.existingContactId;\n  contactAction = 'found';\n} else {\n  // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ - –Ω–µ—Ç ID –∫–æ–Ω—Ç–∞–∫—Ç–∞\n  throw new Error('Contact ID not found in merged data');\n}\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\nreturn [{\n  json: {\n    ...checkContactData,\n    contactId: contactId,\n    contactAction: contactAction,\n    kommoCrmResponse: mergedResult // –î–ª—è –¥–µ–±–∞–≥–∞\n  }\n}];"
      },
      "id": "46a1c17d-ffdc-4683-8048-e77770e990da",
      "name": "Merge Contact Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1536,
        288
      ]
    },
    {
      "parameters": {
        "jsCode": "const leadResult = $('Create Lead').first().json;\nconst contactData = $('Merge Contact Result').first().json;\n\nconst leadId = leadResult._embedded?.leads?.[0]?.id;\n\nreturn [{\n  json: {\n    ...contactData,\n    leadId: leadId,\n    leadUrl: `https://${contactData.subdomain}.kommo.com/leads/detail/${leadId}`,\n    executionTime: Date.now() - contactData.startTime\n  }\n}];"
      },
      "id": "cf8ad264-989f-4a01-b395-a0841bab7038",
      "name": "Prepare Note Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1136,
        288
      ]
    },
    {
      "parameters": {
        "jsCode": "const noteData = $('Prepare Note Data').first().json;\n\nreturn [{\n  json: {\n    ...noteData,\n    noteAdded: true,\n    crmType: 'kommocrm'\n  }\n}];"
      },
      "id": "635d587a-a473-4eaa-b6d7-39dbad5f0847",
      "name": "Prepare Final Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -752,
        288
      ]
    },
    {
      "parameters": {
        "jsCode": "const finalData = $('Prepare Final Data').first().json;\n\nconst shouldSendTelegram = (\n  finalData.sendTelegram === true && \n  finalData.isHotLead === true && \n  finalData.leadScore >= 70\n);\n\nreturn [{\n  json: {\n    ...finalData,\n    shouldSendTelegram: shouldSendTelegram\n  }\n}];"
      },
      "id": "2b32adbd-6dda-4b39-95b0-0d9642f5557c",
      "name": "Prepare Telegram Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -560,
        288
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.shouldSendTelegram }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              },
              "id": "telegram-check"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "d2aa158e-1fef-47e2-bef6-b4e47160eca6",
      "name": "If Send Telegram",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -368,
        288
      ]
    },
    {
      "parameters": {
        "jsCode": "const data = $json;\n\nconst clientName = data.contact.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';\nconst companyName = data.aiCommentInput?.customerProfile?.company || '';  // ‚Üê –ò–°–ü–†–ê–í–õ–ï–ù–û!\nconst email = data.contact.custom_fields_values?.find(f => f.field_id === data.CLIENT_CONFIG.customFields.email)?.values?.[0]?.value || '';\nconst phone = data.contact.custom_fields_values?.find(f => f.field_id === data.CLIENT_CONFIG.customFields.phone)?.values?.[0]?.value || '';\nconst leadScore = data.leadScore || 0;\nconst bantScore = data.bantScore || 0;\nconst opportunity = data.opportunityAmount || 0;\nconst currency = data.CLIENT_CONFIG.defaultCurrency;\nconst stageName = data.stageName || '';\nconst leadId = data.leadId || 'pending';\nconst leadUrl = data.leadUrl || '';\n\nlet message = `üî• <b>–ì–û–†–Ø–ß–ò–ô –õ–ò–î DETECTED!</b>\\n\\n`;\nmessage += `üë§ <b>–ö–ª–∏–µ–Ω—Ç:</b> ${clientName}\\n`;\nif (companyName) {\n  message += `üè¢ <b>–ö–æ–º–ø–∞–Ω–∏—è:</b> ${companyName}\\n`;\n}\nmessage += `\\n`;\nmessage += `üìä <b>Lead Score:</b> ${leadScore}/100\\n`;\nmessage += `üìã <b>BANT Score:</b> ${bantScore}/70\\n`;\nif (opportunity > 0) {\n  message += `üí∞ <b>Opportunity:</b> ${opportunity} ${currency}\\n`;\n}\nmessage += `üìç <b>Stage:</b> ${stageName}\\n`;\nmessage += `\\n`;\nif (email) {\n  message += `üìß <code>${email}</code>\\n`;\n}\nif (phone) {\n  message += `‚òéÔ∏è <code>${phone}</code>\\n`;\n}\nmessage += `\\n`;\nif (leadUrl) {\n  message += `üîó <a href=\"${leadUrl}\">–û—Ç–∫—Ä—ã—Ç—å –ª–∏–¥ –≤ kommoCRM</a>\\n`;\n  message += `\\n`;\n}\nmessage += `‚ö° <b>–¢–†–ï–ë–£–ï–¢–°–Ø –°–†–û–ß–ù–´–ô –û–¢–í–ï–¢!</b>\\n`;\nmessage += `–°–≤—è–∂–∏—Ç–µ—Å—å —Å –∫–ª–∏–µ–Ω—Ç–æ–º –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç\\n`;\nmessage += `\\n`;\nconst now = new Date();\nconst timestamp = now.toLocaleString('ru-RU', { \n  timeZone: 'Europe/Sofia',\n  day: '2-digit',\n  month: '2-digit',\n  year: 'numeric',\n  hour: '2-digit',\n  minute: '2-digit'\n});\nmessage += `‚è∞ ${timestamp}`;\n\nreturn [{\n  json: {\n    message: message,\n    chatId: data.telegramChatId,\n    leadId: leadId,\n    originalData: data\n  }\n}];"
      },
      "id": "e9b95335-ad49-48a2-8dcb-84000d32a37e",
      "name": "Format Telegram Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -160,
        -16
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "HTML"
        }
      },
      "id": "3fc00340-e7f1-4e53-b33a-695a088cd327",
      "name": "Send Telegram Notification",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        32,
        -16
      ],
      "webhookId": "30b2801b-f930-4418-a00b-20880d165081",
      "credentials": {
        "telegramApi": {
          "id": "fn7ywFo6SxQJtPcU",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $('Prepare Final Data').first().json;\n\nconst bantBudget = data.aiCommentInput?.bant?.budget?.score || 0;\nconst bantAuthority = data.aiCommentInput?.bant?.authority?.score || 0;\nconst bantNeed = data.aiCommentInput?.bant?.need?.score || 0;\nconst bantTimeline = data.aiCommentInput?.bant?.timeline?.score || 0;\n\nconst utmSource = data.utmData?.source || 'direct';\nconst utmMedium = data.utmData?.medium || 'none';\nconst utmCampaign = data.utmData?.campaign || '';\n\nreturn [{\n  json: {\n    sessionId: data.sessionId,\n    clientId: data.clientName,\n    status: 'success',\n    leadScore: data.leadScore,\n    leadTemperature: data.leadTemperature,\n    bantScore: data.bantScore,\n    bantQualified: data.bantQualified,\n    bantLevel: data.bantLevel,\n    bantBudgetScore: bantBudget,\n    bantAuthorityScore: bantAuthority,\n    bantNeedScore: bantNeed,\n    bantTimelineScore: bantTimeline,\n    crmType: 'kommocrm',\n    crmContactId: String(data.contactId),\n    crmContactAction: data.contactAction,\n    crmLeadId: String(data.leadId),\n    crmStageId: data.stageId,\n    crmPipelineId: data.pipelineId,\n    opportunityAmount: data.opportunityAmount,\n    telegramSent: data.sendTelegram || false,\n    executionTimeMs: data.executionTime || 0,\n    utmSource: utmSource,\n    utmMedium: utmMedium,\n    utmCampaign: utmCampaign,\n    leadUrl: data.leadUrl,\n    stageName: data.stageName,\n    noteAdded: data.noteAdded,\n    currency: data.CLIENT_CONFIG.defaultCurrency,\n    originalData: data\n  }\n}];"
      },
      "id": "5305843b-6e3e-4b1b-875c-4f89e0eb91fb",
      "name": "Prepare DB Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -176,
        288
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO crm_sent_leads (\n  session_id,\n  crm_type,\n  crm_lead_id,\n  lead_score,\n  lead_temperature,\n  sent_at,\n  webhook_url\n) VALUES (\n  '{{ $json.sessionId }}',\n  '{{ $json.crmType }}',\n  '{{ $json.crmLeadId }}',\n  {{ $json.leadScore }},\n  '{{ $json.leadTemperature }}',\n  NOW(),\n  '{{ $json.leadUrl }}'\n)\nON CONFLICT (session_id) \nDO UPDATE SET\n  crm_lead_id = EXCLUDED.crm_lead_id,\n  lead_score = EXCLUDED.lead_score,\n  lead_temperature = EXCLUDED.lead_temperature,\n  sent_at = EXCLUDED.sent_at,\n  webhook_url = EXCLUDED.webhook_url;",
        "options": {}
      },
      "id": "f718329a-3e57-4f31-8bee-e6b9dc671da9",
      "name": "Save CRM Log",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        32,
        384
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO integration_logs (\n  session_id,\n  client_id,\n  status,\n  crm_type,\n  crm_contact_id,\n  crm_contact_action,\n  crm_deal_id,\n  crm_pipeline_id,\n  crm_stage_id,\n  opportunity_amount,\n  lead_score,\n  bant_score,\n  execution_time_ms,\n  telegram_sent,\n  response_payload,\n  created_at,\n  updated_at\n) VALUES (\n  '{{ $json.sessionId }}',\n  '{{ $json.clientName || \"Unknown\" }}',\n  '{{ $json.status || \"success\" }}',\n  '{{ $json.crmType }}',\n  '{{ $json.crmContactId }}',\n  '{{ $json.crmContactAction }}',\n  '{{ $json.crmLeadId }}',\n  {{ $json.crmPipelineId }},\n  {{ $json.crmStageId }},\n  {{ $json.opportunityAmount }},\n  {{ $json.leadScore }},\n  {{ $json.bantScore }},\n  {{ $json.executionTimeMs }},\n  {{ $json.telegramSent }},\n  '{{ JSON.stringify($json.originalData.aiComment) }}'::jsonb,\n  NOW(),\n  NOW()\n);",
        "options": {}
      },
      "id": "47fb5a71-aed9-4eed-9b60-716727d91504",
      "name": "Save Integration Log",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        32,
        192
      ],
      "alwaysOutputData": false,
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const preparedData = $('Prepare DB Data').first().json;\n\nreturn [{\n  json: {\n    ...preparedData,\n    dbSaved: true\n  }\n}];"
      },
      "id": "21c6c319-ba80-4012-9cdf-11acd282eeeb",
      "name": "Merge DB Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        224,
        288
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  \"success\": true,\n  \"message\": \"Lead successfully sent to amoCRM\",\n  \"sessionId\": $json.sessionId,\n  \"leadId\": $json.crmLeadId,\n  \"contactId\": $json.crmContactId,\n  \"contactAction\": $json.crmContactAction,\n  \"leadScore\": $json.leadScore,\n  \"leadTemperature\": $json.leadTemperature,\n  \"bantScore\": $json.bantScore,\n  \"bantQualified\": $json.bantQualified,\n  \"bantLevel\": $json.bantLevel,\n  \"opportunityAmount\": $json.opportunityAmount,\n  \"currency\": $json.currency,\n  \"stageName\": $json.stageName,\n  \"leadUrl\": $json.leadUrl,\n  \"commentAdded\": $json.commentAdded,\n  \"telegramSent\": $json.telegramSent,\n  \"executionTime\": $json.executionTimeMs + \"ms\",\n  \"dbSaved\": true\n} }}",
        "options": {}
      },
      "id": "6d439d6e-5876-47a5-b38c-ae8718a9dad7",
      "name": "Response Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        416,
        288
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": false,\n  \"error\": \"Validation error\",\n  \"message\": \"Invalid data: {{ $json.validation.missingFields.join(', ') }}\",\n  \"details\": {\n    \"hasEmail\": {{ $json.validation.hasEmail }},\n    \"hasPhone\": {{ $json.validation.hasPhone }},\n    \"hasName\": {{ $json.validation.hasName }},\n    \"missingFields\": {{ JSON.stringify($json.validation.missingFields) }}\n  }\n}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "2f7ce23d-cf6e-4478-942a-da5ca90ae2ac",
      "name": "Response Validation Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2304,
        512
      ]
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -1696,
        288
      ],
      "id": "3fb0b965-3fe7-482c-a75b-376c01d77110",
      "name": "Merge"
    },
    {
      "parameters": {
        "resource": "contacts",
        "filter": {
          "query": "={{ $json.searchData.email || $json.searchData.phone }}"
        },
        "options": {}
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        -2528,
        288
      ],
      "id": "05d5fa73-2dc6-4045-9dd8-0f01e776b124",
      "name": "Get list of contacts",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "Wxsld8cBJ5iVMxyU",
          "name": "Kommo account"
        }
      }
    },
    {
      "parameters": {
        "resource": "contacts",
        "operation": "updateContacts",
        "collection": {
          "contact": [
            {
              "id": "={{ $json.existingContactId }}",
              "name": "={{ $json.contact.name }}",
              "responsible_user_id": "={{ $json.responsibleUserId }}",
              "created_by": "={{ $json.responsibleUserId }}",
              "updated_by": "={{ $json.responsibleUserId }}",
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":668710,\"type\":\"multitext\"}",
                    "value": "={{ $json.aiCommentInput.customerProfile.phone }}"
                  },
                  {
                    "data": "{\"id\":668712,\"type\":\"multitext\"}",
                    "value": "={{ $json.aiCommentInput.customerProfile.email }}"
                  },
                  {
                    "data": "{\"id\":668708,\"type\":\"text\"}",
                    "value": "={{ $json.aiCommentInput.customerProfile.position }}"
                  },
                  {
                    "data": "{\"id\":730828,\"type\":\"text\"}",
                    "value": "={{ $json.aiCommentInput.customerProfile.company }}"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        -1920,
        192
      ],
      "id": "073ba922-baf5-4c62-b131-e4567f479690",
      "name": "Update contacts",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "Wxsld8cBJ5iVMxyU",
          "name": "Kommo account"
        }
      }
    },
    {
      "parameters": {
        "resource": "contacts",
        "operation": "createContacts",
        "collection": {
          "contact": [
            {
              "name": "={{ $json.contact.name }}",
              "first_name": "={{ $json.contact.first_name }}",
              "last_name": "={{ $json.contact.last_name }}",
              "responsible_user_id": "={{ $json.responsibleUserId }}",
              "created_by": "={{ $json.responsibleUserId }}",
              "updated_by": "={{ $json.responsibleUserId }}",
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":668712,\"type\":\"multitext\"}",
                    "value": "={{ $json.aiCommentInput.customerProfile.email }}"
                  },
                  {
                    "data": "{\"id\":668710,\"type\":\"multitext\"}",
                    "value": "={{ $json.aiCommentInput.customerProfile.phone }}"
                  },
                  {
                    "data": "{\"id\":668708,\"type\":\"text\"}",
                    "value": "={{ $json.aiCommentInput.customerProfile.position }}"
                  },
                  {
                    "data": "{\"id\":730828,\"type\":\"text\"}",
                    "value": "={{ $json.aiCommentInput.customerProfile.company }}"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        -1920,
        384
      ],
      "id": "cc27197f-c433-4e86-a4c6-951ca9e38179",
      "name": "Create new contacts",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "Wxsld8cBJ5iVMxyU",
          "name": "Kommo account"
        }
      }
    },
    {
      "parameters": {
        "resource": "notes",
        "operation": "createNotes",
        "notes": {
          "common": [
            {
              "entity_id": "={{ $json.leadId }}",
              "text": "={{ $json.aiComment }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        -928,
        288
      ],
      "id": "5d5586b4-98d3-4502-b7a1-7fb3f67ea109",
      "name": "Add Note to Lead",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "Wxsld8cBJ5iVMxyU",
          "name": "Kommo account"
        }
      }
    },
    {
      "parameters": {
        "resource": "leads",
        "operation": "createLeads",
        "collection": {
          "lead": [
            {
              "name": "={{ $json.lead.name }}",
              "price": "={{ $json.lead.price }}",
              "pipeline_id": "={{ $json.pipelineId }}",
              "status_id": "={{ $json.lead.status_id }}",
              "responsible_user_id": "={{ $json.lead.responsible_user_id }}",
              "_embedded": {
                "contacts": [
                  {
                    "id": {
                      "contact": [
                        {
                          "id": "={{ $json.contactId }}"
                        }
                      ]
                    }
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        -1328,
        288
      ],
      "id": "3d46c7e2-78d5-480f-8e80-1c0543cfcadc",
      "name": "Create Lead",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "Wxsld8cBJ5iVMxyU",
          "name": "Kommo account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://evgenstrizh.kommo.com/api/v4/contacts/custom_fields",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "kommoOAuth2Api",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "[\n  {\n    \"name\": \"Company\",\n    \"type\": \"text\",\n    \"code\": \"COMPANY\"\n  }\n]",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4576,
        0
      ],
      "id": "15715fea-c053-486a-bd22-8c197deaa595",
      "name": "Create Company Field",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "Wxsld8cBJ5iVMxyU",
          "name": "Kommo account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –ó–ê–©–ò–¢–ê: API KEY + RATE LIMITING\n// ============================================\n\n// –ù–ê–°–¢–†–û–ô–ö–ò (–∏–∑–º–µ–Ω–∏ –ø–æ–¥ —Å–µ–±—è)\nconst API_KEY = '24fs-$r4d-defd-77ds-7eds';\nconst RATE_LIMIT_WINDOW_MS = 60000;\nconst RATE_LIMIT_MAX_REQUESTS = 60;\n\nconst inputData = $input.first().json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\n// RATE LIMITING\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) {\n    delete staticData.rateLimits[ip];\n  }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Too many requests', details: `Limit: ${RATE_LIMIT_MAX_REQUESTS} requests per minute`, status: 429, retryAfter: Math.ceil((staticData.rateLimits[clientIP].firstRequest + RATE_LIMIT_WINDOW_MS - now) / 1000) } } }];\n  }\n}\n\n// API KEY CHECK\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'API key not provided', status: 401 } } }];\n}\nif (providedKey !== API_KEY) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Invalid API key', status: 401 } } }];\n}\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4736,
        320
      ],
      "id": "a87c44a0-7619-4b00-9026-2851694655de",
      "name": "Security Check"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "auth-condition",
              "leftValue": "={{ $json.authorized }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4576,
        320
      ],
      "id": "052af7da-ef52-4df3-b8d4-aa54b2cdcc7f",
      "name": "Auth Check"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {
          "responseCode": "={{ $json.error.status }}"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -4384,
        464
      ],
      "id": "b5fe5341-50d6-4a65-bbf1-8335aff5e6aa",
      "name": "Error Response"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Security Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Client Config": {
      "main": [
        [
          {
            "node": "Get Session Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Session Data": {
      "main": [
        [
          {
            "node": "Get Dialog History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Dialog History": {
      "main": [
        [
          {
            "node": "Merge All Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge All Data": {
      "main": [
        [
          {
            "node": "Format Data (Optimized)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Data (Optimized)": {
      "main": [
        [
          {
            "node": "Generate AI Comment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate AI Comment": {
      "main": [
        [
          {
            "node": "Update Deal with AI Comment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Generate AI Comment",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Update Deal with AI Comment": {
      "main": [
        [
          {
            "node": "Validate Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Data": {
      "main": [
        [
          {
            "node": "Get list of contacts",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response Validation Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Contact": {
      "main": [
        [
          {
            "node": "If Contact Exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Contact Exists": {
      "main": [
        [
          {
            "node": "Update contacts",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create new contacts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Contact Result": {
      "main": [
        [
          {
            "node": "Create Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Note Data": {
      "main": [
        [
          {
            "node": "Add Note to Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Final Data": {
      "main": [
        [
          {
            "node": "Prepare Telegram Check",
            "type": "main",
            "index": 0
          },
          {
            "node": "Prepare DB Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Telegram Check": {
      "main": [
        [
          {
            "node": "If Send Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Send Telegram": {
      "main": [
        [
          {
            "node": "Format Telegram Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Telegram Message": {
      "main": [
        [
          {
            "node": "Send Telegram Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare DB Data": {
      "main": [
        [
          {
            "node": "Save CRM Log",
            "type": "main",
            "index": 0
          },
          {
            "node": "Save Integration Log",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save CRM Log": {
      "main": [
        [
          {
            "node": "Merge DB Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Integration Log": {
      "main": [
        [
          {
            "node": "Merge DB Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge DB Results": {
      "main": [
        [
          {
            "node": "Response Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Merge Contact Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create new contacts": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Update contacts": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Note to Lead": {
      "main": [
        [
          {
            "node": "Prepare Final Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get list of contacts": {
      "main": [
        [
          {
            "node": "Check Contact",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Lead": {
      "main": [
        [
          {
            "node": "Prepare Note Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Security Check": {
      "main": [
        [
          {
            "node": "Auth Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Auth Check": {
      "main": [
        [
          {
            "node": "Set Client Config",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "83b439c0-ca14-4553-8d46-51394cdd0bb0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9a2a948e1b1119e76dce477f4f08641c41898f344f4216cb90098437b1dcaf00"
  },
  "id": "qRiH2XAhuvaPwnnF",
  "tags": []
}