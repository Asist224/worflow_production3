{
  "name": "ğŸ§¹ Database Cleanup [Production EN]",
  "nodes": [
    {
      "parameters": {
        "content": "## ğŸ§¹ Database Cleanup\n\n### ğŸ“‹ Description\nAutomated cleanup of outdated data from the database.\n\n**Features:**\n- Auto-cleanup on schedule (daily at 3:00 AM)\n- API to get settings\n- API to update settings\n\n---\n\n### âš™ï¸ CONFIG Setup\n\n| Parameter | Description |\n|-----------|-------------|\n| `api_key` | API key for authentication |\n| `rate_limit_window_ms` | Rate limiting window (ms) |\n| `rate_limit_max_requests` | Max requests per window |\n| `table_webchat_monitoring` | Monitoring table |\n| `table_dialog_analysis` | Analysis table |\n| `table_chat_histories_ru` | Chat history RU |\n| `table_chat_histories_en` | Chat history EN |\n| `table_user_contact_data` | Contact data |\n| `table_cleanup_settings` | Cleanup settings |\n| `table_cleanup_logs` | Cleanup logs |\n\n---\n\n### ğŸ“¥ API Endpoints\n\n**Get settings:**\n```\nGET /webhook/cleanup-settings?apiKey=YOUR_KEY\n```\n\n**Update settings:**\n```json\nPOST /webhook/update-cleanup-settings?apiKey=YOUR_KEY\n{\n  \"monitoringRetention\": 30,\n  \"analysisRetention\": 90,\n  \"dialogsRetention\": 60,\n  \"contactsRetention\": 180\n}\n```",
        "height": 984,
        "width": 580,
        "color": 5
      },
      "id": "24b63159-cc0c-45e2-948b-d197f6347575",
      "name": "ğŸ“ Instructions",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -11888,
        -960
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "api-key",
              "name": "api_key",
              "value": "24fs-$r4d-defd-77ds-7eds",
              "type": "string"
            },
            {
              "id": "rate-window",
              "name": "rate_limit_window_ms",
              "value": 60000,
              "type": "number"
            },
            {
              "id": "rate-max",
              "name": "rate_limit_max_requests",
              "value": 60,
              "type": "number"
            },
            {
              "id": "table-monitoring",
              "name": "table_webchat_monitoring",
              "value": "webchat_monitoring",
              "type": "string"
            },
            {
              "id": "table-analysis",
              "name": "table_dialog_analysis",
              "value": "dialog_analysis",
              "type": "string"
            },
            {
              "id": "table-chat-ru",
              "name": "table_chat_histories_ru",
              "value": "n8n_chat_histories_ru",
              "type": "string"
            },
            {
              "id": "table-chat-en",
              "name": "table_chat_histories_en",
              "value": "n8n_chat_histories_en",
              "type": "string"
            },
            {
              "id": "table-contacts",
              "name": "table_user_contact_data",
              "value": "user_contact_data",
              "type": "string"
            },
            {
              "id": "table-settings",
              "name": "table_cleanup_settings",
              "value": "cleanup_settings",
              "type": "string"
            },
            {
              "id": "table-logs",
              "name": "table_cleanup_logs",
              "value": "cleanup_logs",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "2cf97390-1aa5-429a-ad23-8fd9c9fc271d",
      "name": "âš™ï¸ CONFIG: Cleanup",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -11024,
        -912
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "api-key",
              "name": "api_key",
              "value": "24fs-$r4d-defd-77ds-7eds",
              "type": "string"
            },
            {
              "id": "rate-window",
              "name": "rate_limit_window_ms",
              "value": 60000,
              "type": "number"
            },
            {
              "id": "rate-max",
              "name": "rate_limit_max_requests",
              "value": 60,
              "type": "number"
            },
            {
              "id": "table-settings",
              "name": "table_cleanup_settings",
              "value": "cleanup_settings",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "743b9a2d-08d9-4a12-b311-65a6ca89e089",
      "name": "âš™ï¸ CONFIG: Get Settings",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -11072,
        -544
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "api-key",
              "name": "api_key",
              "value": "24fs-$r4d-defd-77ds-7eds",
              "type": "string"
            },
            {
              "id": "rate-window",
              "name": "rate_limit_window_ms",
              "value": 60000,
              "type": "number"
            },
            {
              "id": "rate-max",
              "name": "rate_limit_max_requests",
              "value": 60,
              "type": "number"
            },
            {
              "id": "table-settings",
              "name": "table_cleanup_settings",
              "value": "cleanup_settings",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "3e8bb46e-d1eb-494d-8ff6-5e60360ca413",
      "name": "âš™ï¸ CONFIG: Update Settings",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -11056,
        -208
      ]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 3 * * *"
            }
          ]
        }
      },
      "id": "0376db58-6e38-4156-9287-a352d1d500be",
      "name": "â° Daily Cleanup 3 AM",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -11216,
        -912
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ“Š Get statistics before cleanup\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nWITH settings AS (\n    SELECT * FROM {{ $('âš™ï¸ CONFIG: Cleanup').first().json.table_cleanup_settings }} LIMIT 1\n),\nsessions_to_delete_ru AS (\n    SELECT session_id FROM {{ $('âš™ï¸ CONFIG: Cleanup').first().json.table_chat_histories_ru }}\n    GROUP BY session_id HAVING MAX(created_at) < NOW() - ((SELECT COALESCE(dialogs_retention_days, 60) FROM settings) || ' days')::INTERVAL\n),\nsessions_to_delete_en AS (\n    SELECT session_id FROM {{ $('âš™ï¸ CONFIG: Cleanup').first().json.table_chat_histories_en }}\n    GROUP BY session_id HAVING MAX(created_at) < NOW() - ((SELECT COALESCE(dialogs_retention_days, 60) FROM settings) || ' days')::INTERVAL\n),\nmonitoring_sessions_to_delete AS (\n    SELECT session_id FROM {{ $('âš™ï¸ CONFIG: Cleanup').first().json.table_webchat_monitoring }}\n    GROUP BY session_id HAVING MAX(last_activity_time) < NOW() - ((SELECT COALESCE(monitoring_retention_days, 30) FROM settings) || ' days')::INTERVAL\n)\nSELECT 'webchat_monitoring' as table_name,\n    (SELECT COUNT(*) FROM {{ $('âš™ï¸ CONFIG: Cleanup').first().json.table_webchat_monitoring }}) as total_records,\n    (SELECT COUNT(*) FROM monitoring_sessions_to_delete) as records_to_delete\nUNION ALL\nSELECT 'dialog_analysis' as table_name,\n    (SELECT COUNT(*) FROM {{ $('âš™ï¸ CONFIG: Cleanup').first().json.table_dialog_analysis }}) as total_records,\n    (SELECT COUNT(*) FROM {{ $('âš™ï¸ CONFIG: Cleanup').first().json.table_dialog_analysis }} WHERE created_at < NOW() - ((SELECT COALESCE(analysis_retention_days, 90) FROM settings) || ' days')::INTERVAL) as records_to_delete\nUNION ALL\nSELECT 'n8n_chat_histories_ru' as table_name,\n    (SELECT COUNT(DISTINCT session_id) FROM {{ $('âš™ï¸ CONFIG: Cleanup').first().json.table_chat_histories_ru }}) as total_records,\n    (SELECT COUNT(*) FROM sessions_to_delete_ru) as records_to_delete\nUNION ALL\nSELECT 'n8n_chat_histories_en' as table_name,\n    (SELECT COUNT(DISTINCT session_id) FROM {{ $('âš™ï¸ CONFIG: Cleanup').first().json.table_chat_histories_en }}) as total_records,\n    (SELECT COUNT(*) FROM sessions_to_delete_en) as records_to_delete\nUNION ALL\nSELECT 'user_contact_data' as table_name,\n    (SELECT COUNT(*) FROM {{ $('âš™ï¸ CONFIG: Cleanup').first().json.table_user_contact_data }}) as total_records,\n    (SELECT COUNT(*) FROM {{ $('âš™ï¸ CONFIG: Cleanup').first().json.table_user_contact_data }} WHERE last_updated < NOW() - ((SELECT COALESCE(contacts_retention_days, 180) FROM settings) || ' days')::INTERVAL) as records_to_delete;",
        "options": {}
      },
      "id": "3f6fd8d7-566f-47af-bdc2-417bca16e481",
      "name": "ğŸ˜ Get Statistics",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -10832,
        -912
      ],
      "credentials": {
        "postgres": {
          "id": "I3pncOwnyKZ5gwoO",
          "name": "Postgres_gmail"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“Š Process cleanup statistics\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst stats = items.map(item => item.json);\nlet totalToDelete = 0;\nstats.forEach(stat => { totalToDelete += parseInt(stat.records_to_delete); });\n\nreturn [{\n    json: {\n        stats: stats,\n        totalToDelete: totalToDelete,\n        timestamp: new Date().toISOString()\n    }\n}];"
      },
      "id": "a09dc8c2-4fae-417a-87a6-6e93f5adf879",
      "name": "ğŸ“Š Log Statistics",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -10656,
        -912
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.totalToDelete }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              },
              "id": "condition-check"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "f9cf8beb-5419-4714-9a8c-cf3f4ac6b5db",
      "name": "â“ Check if Needed",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -10496,
        -912
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// â­ï¸ No data to cleanup\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nreturn [{\n    json: {\n        status: 'skipped',\n        message: 'No records to cleanup',\n        timestamp: new Date().toISOString()\n    }\n}];"
      },
      "id": "d818fbc0-b3dd-4ab4-bd9c-404550cc7193",
      "name": "â­ï¸ No Cleanup Needed",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -10256,
        -720
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM {{ $('âš™ï¸ CONFIG: Cleanup').first().json.table_cleanup_settings }} LIMIT 1;",
        "options": {}
      },
      "id": "c99851ea-852c-4f96-bb24-bd737e4506e8",
      "name": "ğŸ˜ Get Settings (Cleanup)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -10256,
        -928
      ],
      "credentials": {
        "postgres": {
          "id": "I3pncOwnyKZ5gwoO",
          "name": "Postgres_gmail"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ—‘ï¸ Cleanup monitoring\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nWITH deleted AS (\n    DELETE FROM {{ $('âš™ï¸ CONFIG: Cleanup').first().json.table_webchat_monitoring }}\n    WHERE session_id IN (\n        SELECT DISTINCT session_id FROM {{ $('âš™ï¸ CONFIG: Cleanup').first().json.table_webchat_monitoring }}\n        GROUP BY session_id HAVING MAX(last_activity_time) < NOW() - INTERVAL '{{ $json.monitoring_retention_days || 30 }} days'\n    )\n    RETURNING *\n)\nSELECT COUNT(*) as deleted_monitoring FROM deleted;",
        "options": {}
      },
      "id": "6b256e76-fd56-461c-9c1b-2dd2d06749c9",
      "name": "ğŸ˜ Cleanup Monitoring",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -9952,
        -1264
      ],
      "credentials": {
        "postgres": {
          "id": "I3pncOwnyKZ5gwoO",
          "name": "Postgres_gmail"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ—‘ï¸ Cleanup analysis\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nWITH deleted AS (\n    DELETE FROM {{ $('âš™ï¸ CONFIG: Cleanup').first().json.table_dialog_analysis }}\n    WHERE created_at < NOW() - INTERVAL '{{ $json.analysis_retention_days || 90 }} days'\n    RETURNING *\n)\nSELECT COUNT(*) as deleted_analysis FROM deleted;",
        "options": {}
      },
      "id": "bd94d55b-f9b0-419d-b8a1-3d3860bdf263",
      "name": "ğŸ˜ Cleanup Analysis",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -9952,
        -1104
      ],
      "credentials": {
        "postgres": {
          "id": "I3pncOwnyKZ5gwoO",
          "name": "Postgres_gmail"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ—‘ï¸ Cleanup dialogs RU\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nWITH deleted AS (\n    DELETE FROM {{ $('âš™ï¸ CONFIG: Cleanup').first().json.table_chat_histories_ru }}\n    WHERE session_id IN (\n        SELECT DISTINCT session_id FROM {{ $('âš™ï¸ CONFIG: Cleanup').first().json.table_chat_histories_ru }}\n        GROUP BY session_id HAVING MAX(created_at) < NOW() - INTERVAL '{{ $json.dialogs_retention_days || 60 }} days'\n    )\n    RETURNING *\n)\nSELECT COUNT(*) as deleted_dialogs_ru FROM deleted;",
        "options": {}
      },
      "id": "910f032f-ac3a-4185-9610-30bfdf020aa8",
      "name": "ğŸ˜ Cleanup Dialogs RU",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -9952,
        -928
      ],
      "credentials": {
        "postgres": {
          "id": "I3pncOwnyKZ5gwoO",
          "name": "Postgres_gmail"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ—‘ï¸ Cleanup dialogs EN\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nWITH deleted AS (\n    DELETE FROM {{ $('âš™ï¸ CONFIG: Cleanup').first().json.table_chat_histories_en }}\n    WHERE session_id IN (\n        SELECT DISTINCT session_id FROM {{ $('âš™ï¸ CONFIG: Cleanup').first().json.table_chat_histories_en }}\n        GROUP BY session_id HAVING MAX(created_at) < NOW() - INTERVAL '{{ $json.dialogs_retention_days || 60 }} days'\n    )\n    RETURNING *\n)\nSELECT COUNT(*) as deleted_dialogs_en FROM deleted;",
        "options": {}
      },
      "id": "30fb14e6-4e4a-4aef-86dc-64070553759d",
      "name": "ğŸ˜ Cleanup Dialogs EN",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -9952,
        -768
      ],
      "credentials": {
        "postgres": {
          "id": "I3pncOwnyKZ5gwoO",
          "name": "Postgres_gmail"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ—‘ï¸ Cleanup contacts\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nWITH deleted AS (\n    DELETE FROM {{ $('âš™ï¸ CONFIG: Cleanup').first().json.table_user_contact_data }}\n    WHERE last_updated < NOW() - INTERVAL '{{ $json.contacts_retention_days || 180 }} days'\n    RETURNING *\n)\nSELECT COUNT(*) as deleted_contacts FROM deleted;",
        "options": {}
      },
      "id": "f6d43573-35a9-4b57-a3dc-284fa07e9621",
      "name": "ğŸ˜ Cleanup Contacts",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -9952,
        -624
      ],
      "credentials": {
        "postgres": {
          "id": "I3pncOwnyKZ5gwoO",
          "name": "Postgres_gmail"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "numberInputs": 5,
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -9664,
        -976
      ],
      "id": "429c8a63-8d57-42db-a1a5-11df13183a52",
      "name": "ğŸ”€ Merge Results"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“Š Aggregate cleanup results\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst results = {\n  monitoring_deleted: 0,\n  analysis_deleted: 0,\n  dialogs_ru_deleted: 0,\n  dialogs_en_deleted: 0,\n  contacts_deleted: 0\n};\n\nconst allInputs = $input.all();\n\nfor (const item of allInputs) {\n  const data = item.json;\n  if ('deleted_monitoring' in data) { results.monitoring_deleted = parseInt(data.deleted_monitoring) || 0; }\n  if ('deleted_analysis' in data) { results.analysis_deleted = parseInt(data.deleted_analysis) || 0; }\n  if ('deleted_dialogs_ru' in data) { results.dialogs_ru_deleted = parseInt(data.deleted_dialogs_ru) || 0; }\n  if ('deleted_dialogs_en' in data) { results.dialogs_en_deleted = parseInt(data.deleted_dialogs_en) || 0; }\n  if ('deleted_contacts' in data) { results.contacts_deleted = parseInt(data.deleted_contacts) || 0; }\n}\n\nresults.total_deleted = results.monitoring_deleted + results.analysis_deleted + results.dialogs_ru_deleted + results.dialogs_en_deleted + results.contacts_deleted;\n\nreturn [{json: results}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -9488,
        -928
      ],
      "id": "1730b65a-67c7-4871-826c-e891ddd1077a",
      "name": "ğŸ“Š Aggregate Results"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ’¾ Save cleanup log\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nINSERT INTO {{ $('âš™ï¸ CONFIG: Cleanup').first().json.table_cleanup_logs }} (status, cleanup_date)\nVALUES ('completed', NOW())\nRETURNING *;",
        "options": {}
      },
      "id": "09728f29-1c3f-474e-86e8-d6f9c8122e9b",
      "name": "ğŸ˜ Save Cleanup Log",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -9328,
        -928
      ],
      "credentials": {
        "postgres": {
          "id": "I3pncOwnyKZ5gwoO",
          "name": "Postgres_gmail"
        }
      }
    },
    {
      "parameters": {
        "path": "cleanup-settings",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "f221a3b8-f187-4a07-9450-1c8ac4ffbfbe",
      "name": "ğŸŒ Webhook: Get Settings",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -11232,
        -544
      ],
      "webhookId": "cleanup-settings-webhook"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ” Security Check: API KEY + RATE LIMITING\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst config = $('âš™ï¸ CONFIG: Get Settings').first().json;\nconst API_KEY = config.api_key;\nconst RATE_LIMIT_WINDOW_MS = config.rate_limit_window_ms;\nconst RATE_LIMIT_MAX_REQUESTS = config.rate_limit_max_requests;\n\nconst inputData = $('ğŸŒ Webhook: Get Settings').item.json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) { delete staticData.rateLimits[ip]; }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Too many requests', details: `Limit: ${RATE_LIMIT_MAX_REQUESTS} requests per minute`, status: 429 } } }];\n  }\n}\n\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) { return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'API key not provided', status: 401 } } }]; }\nif (providedKey !== API_KEY) { return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Invalid API key', status: 401 } } }]; }\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -10896,
        -544
      ],
      "id": "dccf3ddd-f052-4a8f-a851-a7855042cd1b",
      "name": "ğŸ” Security Check (Get)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "auth-condition",
              "leftValue": "={{ $json.authorized }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -10720,
        -544
      ],
      "id": "47f863cf-54f8-46b7-ae1c-51aa8bc5d175",
      "name": "â“ Auth Check (Get)"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM {{ $('âš™ï¸ CONFIG: Get Settings').first().json.table_cleanup_settings }} LIMIT 1;",
        "options": {}
      },
      "id": "cde106d0-16e7-48b8-b4de-e3d6fe7b3bcb",
      "name": "ğŸ˜ Get Settings",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -10496,
        -592
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  \"status\": \"success\",\n  \"settings\": $json\n} }}",
        "options": {}
      },
      "id": "0c861294-6a86-4d9f-8b19-aa438782d3d3",
      "name": "âœ… Respond Settings",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -10288,
        -592
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {
          "responseCode": "={{ $json.error.status }}"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -10496,
        -448
      ],
      "id": "637145b7-7eee-4e10-b0dc-e871e1dc2383",
      "name": "âŒ Error Response (Get)"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "update-cleanup-settings",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -11232,
        -208
      ],
      "id": "a3f8719c-e94a-4d5e-9e93-b370f42f4fe3",
      "name": "ğŸŒ Webhook: Update Settings",
      "webhookId": "bb5d906f-0618-47dc-bb02-c5cff1bbf303"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ” Security Check: API KEY + RATE LIMITING\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst config = $('âš™ï¸ CONFIG: Update Settings').first().json;\nconst API_KEY = config.api_key;\nconst RATE_LIMIT_WINDOW_MS = config.rate_limit_window_ms;\nconst RATE_LIMIT_MAX_REQUESTS = config.rate_limit_max_requests;\n\nconst inputData = $('ğŸŒ Webhook: Update Settings').item.json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) { delete staticData.rateLimits[ip]; }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Too many requests', details: `Limit: ${RATE_LIMIT_MAX_REQUESTS} requests per minute`, status: 429 } } }];\n  }\n}\n\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) { return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'API key not provided', status: 401 } } }]; }\nif (providedKey !== API_KEY) { return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Invalid API key', status: 401 } } }]; }\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -10864,
        -208
      ],
      "id": "f2557af6-a6f9-4940-bfa8-85d4c4d4d067",
      "name": "ğŸ” Security Check (Update)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "auth-condition",
              "leftValue": "={{ $json.authorized }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -10704,
        -208
      ],
      "id": "83683f6a-d20b-4215-9ea6-7654769d8560",
      "name": "â“ Auth Check (Update)"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“¥ Process update data\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst data = items[0].json.body || items[0].json;\n\nreturn [{\n    json: {\n        monitoring_retention_days: data.monitoringRetention || 30,\n        analysis_retention_days: data.analysisRetention || 90,\n        dialogs_retention_days: data.dialogsRetention || 60,\n        contacts_retention_days: data.contactsRetention || 180\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -10464,
        -272
      ],
      "id": "2de789f7-939b-42f4-a84b-7693e410ebb0",
      "name": "ğŸ“¥ Process Update Data"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ’¾ Update cleanup settings\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nUPDATE {{ $('âš™ï¸ CONFIG: Update Settings').first().json.table_cleanup_settings }}\nSET monitoring_retention_days = {{ $json.monitoring_retention_days }},\n    analysis_retention_days = {{ $json.analysis_retention_days }},\n    dialogs_retention_days = {{ $json.dialogs_retention_days }},\n    contacts_retention_days = {{ $json.contacts_retention_days }},\n    updated_at = NOW()\nWHERE id = 1\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -10256,
        -272
      ],
      "id": "f5a84cbd-8474-43d7-999b-d732137019fd",
      "name": "ğŸ˜ Update Settings",
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\"status\": \"success\", \"message\": \"Cleanup settings updated\", \"data\": $json} }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -10032,
        -272
      ],
      "id": "67f62ff5-a4f1-4263-90c9-d777f101ff9e",
      "name": "âœ… Respond Update"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {
          "responseCode": "={{ $json.error.status }}"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -10464,
        -112
      ],
      "id": "b7954452-6928-450f-bc6e-a93d8361c091",
      "name": "âŒ Error Response (Update)"
    }
  ],
  "pinData": {},
  "connections": {
    "â° Daily Cleanup 3 AM": {
      "main": [
        [
          {
            "node": "âš™ï¸ CONFIG: Cleanup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš™ï¸ CONFIG: Cleanup": {
      "main": [
        [
          {
            "node": "ğŸ˜ Get Statistics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ˜ Get Statistics": {
      "main": [
        [
          {
            "node": "ğŸ“Š Log Statistics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Log Statistics": {
      "main": [
        [
          {
            "node": "â“ Check if Needed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â“ Check if Needed": {
      "main": [
        [
          {
            "node": "ğŸ˜ Get Settings (Cleanup)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "â­ï¸ No Cleanup Needed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ˜ Get Settings (Cleanup)": {
      "main": [
        [
          {
            "node": "ğŸ˜ Cleanup Monitoring",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ˜ Cleanup Analysis",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ˜ Cleanup Dialogs RU",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ˜ Cleanup Dialogs EN",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ˜ Cleanup Contacts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ˜ Cleanup Monitoring": {
      "main": [
        [
          {
            "node": "ğŸ”€ Merge Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ˜ Cleanup Analysis": {
      "main": [
        [
          {
            "node": "ğŸ”€ Merge Results",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "ğŸ˜ Cleanup Dialogs RU": {
      "main": [
        [
          {
            "node": "ğŸ”€ Merge Results",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "ğŸ˜ Cleanup Dialogs EN": {
      "main": [
        [
          {
            "node": "ğŸ”€ Merge Results",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "ğŸ˜ Cleanup Contacts": {
      "main": [
        [
          {
            "node": "ğŸ”€ Merge Results",
            "type": "main",
            "index": 4
          }
        ]
      ]
    },
    "ğŸ”€ Merge Results": {
      "main": [
        [
          {
            "node": "ğŸ“Š Aggregate Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Aggregate Results": {
      "main": [
        [
          {
            "node": "ğŸ˜ Save Cleanup Log",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸŒ Webhook: Get Settings": {
      "main": [
        [
          {
            "node": "âš™ï¸ CONFIG: Get Settings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš™ï¸ CONFIG: Get Settings": {
      "main": [
        [
          {
            "node": "ğŸ” Security Check (Get)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Security Check (Get)": {
      "main": [
        [
          {
            "node": "â“ Auth Check (Get)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â“ Auth Check (Get)": {
      "main": [
        [
          {
            "node": "ğŸ˜ Get Settings",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "âŒ Error Response (Get)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ˜ Get Settings": {
      "main": [
        [
          {
            "node": "âœ… Respond Settings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸŒ Webhook: Update Settings": {
      "main": [
        [
          {
            "node": "âš™ï¸ CONFIG: Update Settings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš™ï¸ CONFIG: Update Settings": {
      "main": [
        [
          {
            "node": "ğŸ” Security Check (Update)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Security Check (Update)": {
      "main": [
        [
          {
            "node": "â“ Auth Check (Update)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â“ Auth Check (Update)": {
      "main": [
        [
          {
            "node": "ğŸ“¥ Process Update Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "âŒ Error Response (Update)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¥ Process Update Data": {
      "main": [
        [
          {
            "node": "ğŸ˜ Update Settings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ˜ Update Settings": {
      "main": [
        [
          {
            "node": "âœ… Respond Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "7b4659ec-b076-489f-be6f-9a467ce974ed",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9a2a948e1b1119e76dce477f4f08641c41898f344f4216cb90098437b1dcaf00"
  },
  "id": "kwbiltkxVdA5HWbR",
  "tags": []
}