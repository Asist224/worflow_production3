{
  "name": "ğŸ”¥ Auto Send Hot Leads to CRM [Production RU]",
  "nodes": [
    {
      "parameters": {
        "content": "## ğŸ”¥ ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ³Ğ¾Ñ€ÑÑ‡Ğ¸Ñ… Ğ»Ğ¸Ğ´Ğ¾Ğ² Ğ² CRM\n\n### ğŸ“‹ ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ\nĞ­Ñ‚Ğ¾Ñ‚ workflow Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ³Ğ¾Ñ€ÑÑ‡Ğ¸Ñ… Ğ»Ğ¸Ğ´Ğ¾Ğ² (Ñ Ğ²Ñ‹ÑĞ¾ĞºĞ¸Ğ¼ lead score) Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¸Ñ… Ğ² CRM ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ Ñ‡ĞµÑ€ĞµĞ· webhook.\n\n### âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°\n\n**1. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ âš™ï¸ CONFIG: Hot Leads:**\n- `api_key` - API ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ²ĞµĞ±Ñ…ÑƒĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ² CRM\n- `crm_webhook_url` - URL Ğ²ĞµĞ±Ñ…ÑƒĞºĞ° CRM Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ KommoCRM, Bitrix24)\n- `table_*` - Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ† Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…\n- `leads_limit` - Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ»Ğ¸Ğ´Ğ¾Ğ² Ğ·Ğ° Ğ¾Ğ´Ğ¸Ğ½ Ğ·Ğ°Ğ¿ÑƒÑĞº\n- `wait_seconds` - Ğ¿Ğ°ÑƒĞ·Ğ° Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ°Ğ¼Ğ¸ (Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ğ½Ğ¸Ğµ rate limit)\n- `lookback_days` - Ğ¸ÑĞºĞ°Ñ‚ÑŒ Ğ»Ğ¸Ğ´Ğ¾Ğ² Ğ·Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ N Ğ´Ğ½ĞµĞ¹\n\n**2. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ PostgreSQL credentials** Ğ² ÑƒĞ·Ğ»Ğ°Ñ… ğŸ˜ PostgreSQL\n\n**3. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ** Ğ² ÑƒĞ·Ğ»Ğµ â° Schedule Trigger (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚)\n\n### ğŸ“Š Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹\n1. ĞŸĞ¾ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ CRM\n2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ° Ğ»Ğ¸ Ğ°Ğ²Ñ‚Ğ¾-Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ°\n3. ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ³Ğ¾Ñ€ÑÑ‡Ğ¸Ñ… Ğ»Ğ¸Ğ´Ğ¾Ğ² (score >= min_lead_score Ğ¸Ğ· Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº)\n4. ĞŸĞ¾Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ½Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ»Ğ¸Ğ´Ğ° Ñ‡ĞµÑ€ĞµĞ· webhook\n5. Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ°Ğ¶Ğ´ÑƒÑ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºÑƒ Ğ² automation_log\n6. Ğ”ĞµĞ»Ğ°ĞµÑ‚ Ğ¿Ğ°ÑƒĞ·Ñƒ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ°Ğ¼Ğ¸\n\n### ğŸ“ Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğº Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°Ğ¼\n- `crm_settings` - Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ CRM (auto_send_enabled, min_lead_score, webhook_url)\n- `dialog_analysis` - Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²\n- `user_contact_data` - ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹\n- `crm_sent_leads` - Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ»Ğ¸Ğ´Ñ‹ (Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğ²)\n- `automation_log` - Ğ»Ğ¾Ğ³ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹"
      },
      "id": "sticky-note-instructions",
      "name": "ğŸ“ Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1200,
        -400
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "config-api-key",
              "name": "api_key",
              "value": "24fs-$r4d-defd-77ds-7eds",
              "type": "string"
            },
            {
              "id": "config-crm-webhook-url",
              "name": "crm_webhook_url",
              "value": "http://localhost:5678/webhook/send-to-kommocrm",
              "type": "string"
            },
            {
              "id": "config-table-crm-settings",
              "name": "table_crm_settings",
              "value": "crm_settings",
              "type": "string"
            },
            {
              "id": "config-table-dialog-analysis",
              "name": "table_dialog_analysis",
              "value": "dialog_analysis",
              "type": "string"
            },
            {
              "id": "config-table-user-contact-data",
              "name": "table_user_contact_data",
              "value": "user_contact_data",
              "type": "string"
            },
            {
              "id": "config-table-webchat-monitoring",
              "name": "table_webchat_monitoring",
              "value": "webchat_monitoring",
              "type": "string"
            },
            {
              "id": "config-table-crm-sent-leads",
              "name": "table_crm_sent_leads",
              "value": "crm_sent_leads",
              "type": "string"
            },
            {
              "id": "config-table-automation-log",
              "name": "table_automation_log",
              "value": "automation_log",
              "type": "string"
            },
            {
              "id": "config-leads-limit",
              "name": "leads_limit",
              "value": 10,
              "type": "number"
            },
            {
              "id": "config-wait-seconds",
              "name": "wait_seconds",
              "value": 10,
              "type": "number"
            },
            {
              "id": "config-lookback-days",
              "name": "lookback_days",
              "value": 7,
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "config-hot-leads",
      "name": "âš™ï¸ CONFIG: Hot Leads",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -864,
        -300
      ]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 15
            }
          ]
        }
      },
      "id": "1c6a2bb9-bcff-4467-93c0-6a96539b2cba",
      "name": "â° Every 15 minutes",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -864,
        -112
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  auto_send_enabled,\n  min_lead_score,\n  webhook_url\nFROM {{ $('âš™ï¸ CONFIG: Hot Leads').first().json.table_crm_settings }} \nWHERE crm_type = 'bitrix24' \nLIMIT 1",
        "options": {}
      },
      "id": "fca26dec-77e6-4029-8999-c916675fc3fa",
      "name": "ğŸ˜ Get CRM Settings",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -656,
        -112
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "8f7e6d5c-4b3a-2910-1234-567890abcdef",
              "leftValue": "={{ $json.auto_send_enabled }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "0d878c7b-f9ed-4b0f-968c-5203a70af002",
      "name": "ğŸ”€ Check Auto Send Enabled",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -464,
        -112
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  da.session_id,\n  COALESCE((da.lead_scoring::json->>'score')::int, 0) as lead_score,\n  (da.emotional_tone::json->>'satisfaction')::int as satisfaction,\n  ucd.phone,\n  ucd.email,\n  ucd.full_name,\n  wm.platform,\n  wm.message_count\nFROM {{ $('âš™ï¸ CONFIG: Hot Leads').first().json.table_dialog_analysis }} da\nJOIN {{ $('âš™ï¸ CONFIG: Hot Leads').first().json.table_user_contact_data }} ucd ON da.session_id = ucd.session_id\nLEFT JOIN {{ $('âš™ï¸ CONFIG: Hot Leads').first().json.table_webchat_monitoring }} wm ON da.session_id = wm.session_id\nLEFT JOIN {{ $('âš™ï¸ CONFIG: Hot Leads').first().json.table_crm_sent_leads }} csl ON da.session_id = csl.session_id\nWHERE \n  csl.session_id IS NULL -- Ğ½Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½ Ğ² CRM\n  AND COALESCE((da.lead_scoring::json->>'score')::int, 0) >= {{ $('ğŸ˜ Get CRM Settings').first().json.min_lead_score }}\n  AND (ucd.phone IS NOT NULL OR ucd.email IS NOT NULL) -- ĞµÑÑ‚ÑŒ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹\n  AND da.created_at > NOW() - INTERVAL '{{ $('âš™ï¸ CONFIG: Hot Leads').first().json.lookback_days }} days'\nLIMIT {{ $('âš™ï¸ CONFIG: Hot Leads').first().json.leads_limit }}",
        "options": {}
      },
      "id": "769dc542-5c18-422e-a3a9-9d9aee7afbd1",
      "name": "ğŸ” Find Hot Leads",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -256,
        -112
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "f7ad393d-a332-46e3-be36-94f43ce0418f",
      "name": "ğŸ“¦ Split in Batches",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 2,
      "position": [
        -64,
        -112
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('âš™ï¸ CONFIG: Hot Leads').first().json.crm_webhook_url }}",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "apiKey",
              "value": "={{ $('âš™ï¸ CONFIG: Hot Leads').first().json.api_key }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"sessionId\": \"{{ $json.session_id }}\",\n  \"autoSend\": true,\n  \"webhookUrl\": \"{{ $('ğŸ˜ Get CRM Settings').first().json.webhook_url }}\"\n}",
        "options": {}
      },
      "id": "344a0060-5e5b-4b42-9730-684d84f5cb94",
      "name": "ğŸ“¤ Send to CRM",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        144,
        -128
      ],
      "retryOnFail": true,
      "maxTries": 2,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO {{ $('âš™ï¸ CONFIG: Hot Leads').first().json.table_automation_log }} (\n  action_type,\n  session_id,\n  details,\n  created_at\n) VALUES (\n  'auto_crm_send',\n  '{{ $('ğŸ“¤ Send to CRM').item.json.sessionId }}',\n  '{{ JSON.stringify($json) }}'::jsonb,\n  NOW()\n)",
        "options": {}
      },
      "id": "68143af6-e9a5-49e0-90b2-7fbf3e7e905f",
      "name": "ğŸ“‹ Log Action",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        352,
        -128
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "amount": "={{ $('âš™ï¸ CONFIG: Hot Leads').first().json.wait_seconds }}",
        "unit": "seconds"
      },
      "id": "337a4cd5-4a94-4be7-a917-7c9807813150",
      "name": "â³ Wait Between Sends",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        544,
        -128
      ],
      "webhookId": "wait-webhook"
    },
    {
      "parameters": {},
      "id": "a4870c4f-4a43-4275-a999-7476ded75b6e",
      "name": "ğŸ›‘ Stop (Auto Send Disabled)",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -256,
        64
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "â° Every 15 minutes": {
      "main": [
        [
          {
            "node": "âš™ï¸ CONFIG: Hot Leads",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš™ï¸ CONFIG: Hot Leads": {
      "main": [
        [
          {
            "node": "ğŸ˜ Get CRM Settings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ˜ Get CRM Settings": {
      "main": [
        [
          {
            "node": "ğŸ”€ Check Auto Send Enabled",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Check Auto Send Enabled": {
      "main": [
        [
          {
            "node": "ğŸ” Find Hot Leads",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ›‘ Stop (Auto Send Disabled)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Find Hot Leads": {
      "main": [
        [
          {
            "node": "ğŸ“¦ Split in Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¦ Split in Batches": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Send to CRM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¤ Send to CRM": {
      "main": [
        [
          {
            "node": "ğŸ“‹ Log Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ Log Action": {
      "main": [
        [
          {
            "node": "â³ Wait Between Sends",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â³ Wait Between Sends": {
      "main": [
        [
          {
            "node": "ğŸ“¦ Split in Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "a3946a71-e0bb-4310-bae4-a0b02048d037-ru",
  "meta": {
    "instanceId": "9a2a948e1b1119e76dce477f4f08641c41898f344f4216cb90098437b1dcaf00"
  },
  "id": "Ar0GfiOsniVchXWb-ru",
  "tags": []
}