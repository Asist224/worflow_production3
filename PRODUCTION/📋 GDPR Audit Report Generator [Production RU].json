{
  "name": "üìã GDPR Audit Report Generator [Production RU]",
  "nodes": [
    {
      "parameters": {
        "content": "## üìã GDPR Audit Report Generator\n\n### üìã –û–ø–∏—Å–∞–Ω–∏–µ\n–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ—Ç—á—ë—Ç–æ–≤ –∞—É–¥–∏—Ç–∞ GDPR (—Å—Ç–∞—Ç—å—è 30). –°–æ–∑–¥–∞—ë—Ç –ø–æ–ª–Ω—ã–µ –æ—Ç—á—ë—Ç—ã –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å—É–±—ä–µ–∫—Ç–∞ –¥–∞–Ω–Ω—ã—Ö.\n\n**–§—É–Ω–∫—Ü–∏–∏:**\n- –ü–æ–∏—Å–∫ –ø–æ Session ID –∏–ª–∏ Email\n- –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON, CSV, PDF/HTML\n- –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Å–æ–≥–ª–∞—Å–∏–π\n- –ê—É–¥–∏—Ç-–ª–æ–≥ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π\n\n---\n\n### ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CONFIG\n\n| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ |\n|----------|----------|\n| `api_key` | API –∫–ª—é—á –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ |\n| `rate_limit_window_ms` | –û–∫–Ω–æ rate limiting (–º—Å) |\n| `rate_limit_max_requests` | –ú–∞–∫—Å. –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –æ–∫–Ω–µ |\n| `table_gdpr_audit_log` | –¢–∞–±–ª–∏—Ü–∞ –∞—É–¥–∏—Ç-–ª–æ–≥–æ–≤ GDPR |\n| `table_gdpr_consents` | –¢–∞–±–ª–∏—Ü–∞ —Å–æ–≥–ª–∞—Å–∏–π GDPR |\n| `table_user_contact_data` | –¢–∞–±–ª–∏—Ü–∞ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö |\n| `table_prechat_submissions` | –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–µ—á–∞—Ç-—Ñ–æ—Ä–º |\n\n---\n\n### üì• API –≠–Ω–¥–ø–æ–∏–Ω—Ç\n\n**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞:**\n```json\nPOST /webhook/gdpr-audit-report?apiKey=YOUR_KEY\n{\n  \"sessionId\": \"uuid-session-id\",\n  \"email\": \"user@example.com\",\n  \"format\": \"json\"\n}\n```\n\n**–§–æ—Ä–º–∞—Ç—ã:** `json`, `csv`, `pdf`\n\n---\n\n### üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ–º–ø–∞–Ω–∏–∏\n\n–í —É–∑–ª–µ `üìä Format Audit Report` –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ:\n- `companyRole` - —Ä–æ–ª—å –ø–æ GDPR\n- `dpoEmail` - email DPO\n- `legalBasis` - –ø—Ä–∞–≤–æ–≤–æ–µ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ\n- `processingPurposes` - —Ü–µ–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏\n- `retentionPolicy` - —Å—Ä–æ–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è",
        "height": 1024,
        "width": 580,
        "color": 5
      },
      "id": "sticky-note-ru",
      "name": "üìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -7100,
        -900
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "gdpr-audit-report",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "65f1f540-d5d1-4abd-b4e6-7127114519dd",
      "name": "üåê Webhook: Audit Report",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -6736,
        -752
      ],
      "webhookId": "gdpr-audit-report-webhook"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "api-key",
              "name": "api_key",
              "value": "YOUR_API_KEY_HERE",
              "type": "string"
            },
            {
              "id": "rate-window",
              "name": "rate_limit_window_ms",
              "value": 60000,
              "type": "number"
            },
            {
              "id": "rate-max",
              "name": "rate_limit_max_requests",
              "value": 30,
              "type": "number"
            },
            {
              "id": "table-audit",
              "name": "table_gdpr_audit_log",
              "value": "gdpr_audit_log",
              "type": "string"
            },
            {
              "id": "table-consents",
              "name": "table_gdpr_consents",
              "value": "gdpr_consents",
              "type": "string"
            },
            {
              "id": "table-contacts",
              "name": "table_user_contact_data",
              "value": "user_contact_data",
              "type": "string"
            },
            {
              "id": "table-prechat",
              "name": "table_prechat_submissions",
              "value": "prechat_submissions",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "config-audit-ru",
      "name": "‚öôÔ∏è CONFIG: Audit Report",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -6544,
        -752
      ]
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: API KEY + RATE LIMITING\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst config = $('‚öôÔ∏è CONFIG: Audit Report').first().json;\nconst API_KEY = config.api_key;\nconst RATE_LIMIT_WINDOW_MS = config.rate_limit_window_ms;\nconst RATE_LIMIT_MAX_REQUESTS = config.rate_limit_max_requests;\n\nconst inputData = $('üåê Webhook: Audit Report').item.json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\n// RATE LIMITING\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) {\n    delete staticData.rateLimits[ip];\n  }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Too many requests', status: 429 } } }];\n  }\n}\n\n// API KEY CHECK\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey || providedKey !== API_KEY) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Unauthorized', status: 401 } } }];\n}\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -6336,
        -752
      ],
      "id": "74522d2f-b055-43df-8053-e761f7bc5cfa",
      "name": "üîê Security Check"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "auth-condition",
              "leftValue": "={{ $json.authorized }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -6144,
        -752
      ],
      "id": "cc497cdd-69f5-4514-a0d6-9e1547a464cd",
      "name": "‚ùì Auth Check"
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// üì• –ü–∞—Ä—Å–∏–Ω–≥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst webhookData = $('üåê Webhook: Audit Report').first().json;\nconst body = webhookData.body || webhookData;\n\nconst sessionId = body.sessionId || body.session_id || null;\nconst email = body.email || null;\nconst format = body.format || 'json';\n\n// –í–∞–ª–∏–¥–∞—Ü–∏—è - –Ω—É–∂–µ–Ω —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä –ø–æ–∏—Å–∫–∞\nif (!sessionId && !email) {\n    throw new Error('Please provide Session ID or Email to search');\n}\n\nreturn [{\n    json: {\n        session_id: sessionId,\n        email: email ? email.toLowerCase().trim() : null,\n        format: format,\n        search_by: sessionId ? 'session_id' : 'email',\n        requested_at: new Date().toISOString()\n    }\n}];"
      },
      "id": "ec5f5768-87be-47fd-9afd-b44727f38587",
      "name": "üì• Parse Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5936,
        -816
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "has-session-id",
              "leftValue": "={{ $json.session_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5728,
        -816
      ],
      "id": "154dc21b-fd9e-4717-98d4-aae7850429ca",
      "name": "‚ùì Has Session ID?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n-- üîç –ü–æ–∏—Å–∫ session_id –ø–æ email\n-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nSELECT DISTINCT session_id, email, 'user_contact_data' as source\nFROM {{ $('‚öôÔ∏è CONFIG: Audit Report').first().json.table_user_contact_data }}\nWHERE LOWER(email) = LOWER('{{ $json.email }}')\n\nUNION\n\nSELECT DISTINCT session_id, email, 'prechat_submissions' as source\nFROM {{ $('‚öôÔ∏è CONFIG: Audit Report').first().json.table_prechat_submissions }}\nWHERE LOWER(email) = LOWER('{{ $json.email }}');",
        "options": {}
      },
      "id": "cdb2edad-e087-4102-8e34-b24974028201",
      "name": "üêò Find Sessions by Email",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -5504,
        -720
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// üìã –°–±–æ—Ä –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö session_id\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst requestData = $('üì• Parse Request').first().json;\nconst emailResults = $('üêò Find Sessions by Email').all().map(i => i.json).filter(i => i && i.session_id);\n\nif (emailResults.length === 0) {\n    // Email –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ –≤ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ\n    return [{\n        json: {\n            session_ids: [],\n            email: requestData.email,\n            found: false,\n            format: requestData.format,\n            message: 'No sessions found for this email'\n        }\n    }];\n}\n\n// –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ session_id\nconst sessionIds = [...new Set(emailResults.map(r => r.session_id))];\n\nreturn [{\n    json: {\n        session_ids: sessionIds,\n        email: requestData.email,\n        found: true,\n        format: requestData.format,\n        sources: emailResults.map(r => ({ session_id: r.session_id, source: r.source }))\n    }\n}];"
      },
      "id": "5a000832-fecb-498f-9871-acd6a7fc5d0e",
      "name": "üìã Prepare Session IDs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5280,
        -720
      ]
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// üìã –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä—è–º–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ session_id\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst requestData = $('üì• Parse Request').first().json;\n\nreturn [{\n    json: {\n        session_ids: [requestData.session_id],\n        session_id: requestData.session_id,\n        email: null,\n        found: true,\n        format: requestData.format\n    }\n}];"
      },
      "id": "7d936880-eeeb-45c4-a3a7-c846dd96a863",
      "name": "üìã Prepare Direct Search",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5504,
        -912
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "has-sessions",
              "leftValue": "={{ $json.found }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5072,
        -832
      ],
      "id": "4fc83f35-53ac-4b06-bcba-b9c60be729b1",
      "name": "‚ùì Sessions Found?"
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// üîß –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ SQL IN clause –¥–ª—è session_ids\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst data = items[0].json;\nconst sessionIds = data.session_ids || [];\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è SQL IN\nconst sessionIdsSQL = sessionIds.map(id => `'${id}'`).join(', ');\n\nreturn [{\n    json: {\n        ...data,\n        session_ids_sql: sessionIdsSQL\n    }\n}];"
      },
      "id": "b8cf4df6-652b-4c47-821d-7dbb1803da96",
      "name": "üîß Prepare SQL Query",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4848,
        -896
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n-- üìú –ü–æ–ª—É—á–µ–Ω–∏–µ –∞—É–¥–∏—Ç-–ª–æ–≥–æ–≤\n-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nSELECT \n    id,\n    session_id,\n    action,\n    details,\n    ip_address,\n    user_agent,\n    domain,\n    created_at,\n    purpose,\n    legal_basis,\n    controller,\n    data_categories,\n    privacy_policy_version\nFROM {{ $('‚öôÔ∏è CONFIG: Audit Report').first().json.table_gdpr_audit_log }}\nWHERE session_id IN ({{ $json.session_ids_sql }})\nORDER BY created_at ASC;",
        "options": {}
      },
      "id": "f3fde601-9599-42df-bb5b-1cb417fef55a",
      "name": "üêò Get Audit Logs",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -4640,
        -1088
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n-- üìú –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π —Å–æ–≥–ª–∞—Å–∏–π\n-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nSELECT \n    session_id,\n    user_email,\n    consent_given,\n    consent_type,\n    privacy_policy_version,\n    is_active,\n    revoked_at,\n    revoke_reason,\n    created_at,\n    expires_at,\n    domain\nFROM {{ $('‚öôÔ∏è CONFIG: Audit Report').first().json.table_gdpr_consents }}\nWHERE session_id IN ({{ $('üîß Prepare SQL Query').first().json.session_ids_sql }})\nORDER BY created_at ASC;",
        "options": {}
      },
      "id": "f1af2c44-694b-418f-9f4b-82b239889c79",
      "name": "üêò Get Consent Records",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -4640,
        -896
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n-- üìß –ü–æ–ª—É—á–µ–Ω–∏–µ email –∏ –∏–º–µ–Ω–∏ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º\n-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nSELECT DISTINCT ON (session_id)\n    session_id,\n    email,\n    name,\n    source,\n    created_at\nFROM (\n    -- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: prechat_submissions\n    SELECT \n        session_id, \n        email, \n        name,\n        'prechat_submissions' as source,\n        1 as priority,\n        created_at\n    FROM {{ $('‚öôÔ∏è CONFIG: Audit Report').first().json.table_prechat_submissions }}\n    WHERE session_id IN ({{ $('üîß Prepare SQL Query').first().json.session_ids_sql }})\n    AND (email IS NOT NULL AND email != '')\n\n    UNION ALL\n\n    -- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: user_contact_data (fallback)\n    SELECT \n        session_id, \n        email, \n        COALESCE(full_name, CONCAT_WS(' ', first_name, last_name)) as name,\n        'user_contact_data' as source,\n        2 as priority,\n        created_at\n    FROM {{ $('‚öôÔ∏è CONFIG: Audit Report').first().json.table_user_contact_data }}\n    WHERE session_id IN ({{ $('üîß Prepare SQL Query').first().json.session_ids_sql }})\n    AND (email IS NOT NULL AND email != '')\n) combined\nORDER BY session_id, priority, created_at DESC;",
        "options": {}
      },
      "id": "4b39dbac-7ead-4b36-8b1f-2795cb8e8d57",
      "name": "üêò Get User Emails",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -4624,
        -704
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -4400,
        -912
      ],
      "id": "665cb76b-5810-4592-8e76-dc21b3a686a1",
      "name": "üîÄ Merge Audit+Consent"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -4224,
        -816
      ],
      "id": "72162c8a-dfd7-45e8-850f-f37f6f7aede3",
      "name": "üîÄ Merge All Data"
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// ‚öôÔ∏è –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø - –ò–ó–ú–ï–ù–ò–¢–ï –î–õ–Ø –í–ê–®–ï–ô –ö–û–ú–ü–ê–ù–ò–ò\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst CONFIG = {\n    // –†–æ–ª—å –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ GDPR: 'Data Controller' –∏–ª–∏ 'Data Processor'\n    // –ü—Ä–∏–º–µ—Ä: 'Data Controller'\n    companyRole: 'Data Processor',\n    \n    // Email DPO (Data Protection Officer)\n    // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ null –¥–ª—è –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑ –¥–æ–º–µ–Ω–∞ (dpo@yourdomain.com)\n    // –ü—Ä–∏–º–µ—Ä: 'privacy@yourcompany.com' –∏–ª–∏ 'dpo@yourcompany.com' –∏–ª–∏ null\n    dpoEmail: null,\n    \n    // –ü—Ä–∞–≤–æ–≤–æ–µ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö (—Å—Ç–∞—Ç—å—è 6 GDPR)\n    // –ü—Ä–∏–º–µ—Ä: 'Consent (GDPR Article 6(1)(a))'\n    // –ü—Ä–∏–º–µ—Ä: 'Contract (GDPR Article 6(1)(b))'\n    // –ü—Ä–∏–º–µ—Ä: 'Legitimate Interest (GDPR Article 6(1)(f))'\n    legalBasis: 'Consent (GDPR Article 6(1)(a))',\n    \n    // –¶–µ–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö (–º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫)\n    // –ü—Ä–∏–º–µ—Ä: ['marketing', 'analytics', 'customer_support']\n    processingPurposes: [\n        'lead_qualification',\n        'customer_support'\n    ],\n    \n    // –°—Ä–æ–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (–æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –æ—Ç—á—ë—Ç–µ)\n    // –ò–∑–º–µ–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–Ω–æ –≤–∞—à–µ–π –ø–æ–ª–∏—Ç–∏–∫–µ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö\n    retentionPolicy: {\n        chatHistory: '365 –¥–Ω–µ–π',\n        consentRecords: '5 –ª–µ—Ç (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞)',\n        auditLogs: '7 –ª–µ—Ç (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –ø–æ–¥–æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏)'\n    },\n    \n    // –ú–µ—Ä—ã –∑–∞—â–∏—Ç—ã –¥–∞–Ω–Ω—ã—Ö (–æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –æ—Ç—á—ë—Ç–µ)\n    // –î–æ–±–∞–≤—å—Ç–µ –∏–ª–∏ —É–¥–∞–ª–∏—Ç–µ –ø—É–Ω–∫—Ç—ã —Å–æ–≥–ª–∞—Å–Ω–æ –≤–∞—à–∏–º –º–µ—Ä–∞–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\n    dataProtectionMeasures: [\n        '–î–∞–Ω–Ω—ã–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ (TLS 1.3)',\n        '–î–∞–Ω–Ω—ã–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã –ø—Ä–∏ —Ö—Ä–∞–Ω–µ–Ω–∏–∏ (AES-256)',\n        '–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞',\n        '–í–µ–¥—ë—Ç—Å—è –∞—É–¥–∏—Ç-–ª–æ–≥',\n        '–ü—Ä–æ–≤–æ–¥—è—Ç—Å—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏'\n    ],\n    \n    // –ü—Ä–∞–≤–∞ —Å—É–±—ä–µ–∫—Ç–∞ –¥–∞–Ω–Ω—ã—Ö (–æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –æ—Ç—á—ë—Ç–µ)\n    // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–∞–≤–∞ GDPR - –æ–±—ã—á–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è\n    dataSubjectRights: [\n        '–ü—Ä–∞–≤–æ –Ω–∞ –¥–æ—Å—Ç—É–ø (–°—Ç–∞—Ç—å—è 15)',\n        '–ü—Ä–∞–≤–æ –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–°—Ç–∞—Ç—å—è 16)',\n        '–ü—Ä–∞–≤–æ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ (–°—Ç–∞—Ç—å—è 17)',\n        '–ü—Ä–∞–≤–æ –Ω–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–°—Ç–∞—Ç—å—è 18)',\n        '–ü—Ä–∞–≤–æ –Ω–∞ –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö (–°—Ç–∞—Ç—å—è 20)',\n        '–ü—Ä–∞–≤–æ –Ω–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ (–°—Ç–∞—Ç—å—è 21)'\n    ]\n};\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// ‚õî –ù–ï –ò–ó–ú–ï–ù–Ø–ô–¢–ï –ö–û–î –ù–ò–ñ–ï –≠–¢–û–ô –°–¢–†–û–ö–ò\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç GDPR Audit\nconst searchParams = $('üîß Prepare SQL Query').first().json;\n\n// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö –Ω–æ–¥\nlet auditLogs = [];\nlet consentRecords = [];\nlet userEmails = [];\n\ntry {\n    const auditLogsRaw = $('üêò Get Audit Logs').all();\n    auditLogs = auditLogsRaw\n        .map(i => i.json)\n        .filter(item => item && item.id);\n} catch (e) {\n    auditLogs = [];\n}\n\ntry {\n    const consentRecordsRaw = $('üêò Get Consent Records').all();\n    consentRecords = consentRecordsRaw\n        .map(i => i.json)\n        .filter(item => item && item.session_id);\n} catch (e) {\n    consentRecords = [];\n}\n\ntry {\n    const userEmailsRaw = $('üêò Get User Emails').all();\n    userEmails = userEmailsRaw\n        .map(i => i.json)\n        .filter(item => item && item.email);\n} catch (e) {\n    userEmails = [];\n}\n\n// –°–æ–∑–¥–∞—ë–º –º–∞–ø–ø–∏–Ω–≥ session_id -> email/name\nconst sessionEmailMap = {};\nuserEmails.forEach(u => {\n    if (!sessionEmailMap[u.session_id]) {\n        sessionEmailMap[u.session_id] = {\n            email: u.email,\n            name: u.name,\n            source: u.source\n        };\n    }\n});\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π email (–ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π –∏–ª–∏ –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–∏—Å–∫–∞)\nconst primaryEmail = searchParams.email || (userEmails[0]?.email) || null;\nconst primaryName = userEmails[0]?.name || null;\n\n// –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö\nif (auditLogs.length === 0 && consentRecords.length === 0) {\n    return [{\n        json: {\n            report: {\n                reportMetadata: {\n                    title: 'GDPR –°—Ç–∞—Ç—å—è 30 - –ó–∞–ø–∏—Å—å –æ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ',\n                    subtitle: '–ê—É–¥–∏—Ç-–æ—Ç—á—ë—Ç —Å—É–±—ä–µ–∫—Ç–∞ –¥–∞–Ω–Ω—ã—Ö',\n                    generatedAt: new Date().toISOString(),\n                    generatedBy: 'GDPR Compliance System',\n                    reportFormat: searchParams.format,\n                    queryParameters: {\n                        sessionIds: searchParams.session_ids,\n                        email: searchParams.email\n                    },\n                    noDataFound: true\n                },\n                dataSubjectSummary: {\n                    sessionIds: searchParams.session_ids,\n                    email: searchParams.email,\n                    totalAuditRecords: 0,\n                    totalConsentRecords: 0,\n                    dataCategories: [],\n                    actionBreakdown: {}\n                },\n                processingActivities: [],\n                consentHistory: [],\n                message: '–ó–∞–ø–∏—Å–∏ –∞—É–¥–∏—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤'\n            },\n            format: searchParams.format,\n            session_ids: searchParams.session_ids,\n            email: searchParams.email,\n            totalRecords: 0\n        }\n    }];\n}\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –∏ –¥–æ–º–µ–Ω\nconst primaryDomain = auditLogs[0]?.domain || consentRecords[0]?.domain || 'Unknown';\nconst controller = auditLogs[0]?.controller || primaryDomain;\nconst cleanDomain = String(primaryDomain).replace(/^https?:\\/\\//, '').split('/')[0];\n\n// DPO email - –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –∏–ª–∏ –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è\nconst dpoEmail = CONFIG.dpoEmail || ('dpo@' + cleanDomain);\n\n// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–µ–π—Å—Ç–≤–∏—è–º\nconst actionStats = {};\nauditLogs.forEach(log => {\n    if (log.action) {\n        actionStats[log.action] = (actionStats[log.action] || 0) + 1;\n    }\n});\n\n// –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö\nconst allCategories = new Set();\nauditLogs.forEach(log => {\n    if (log.data_categories && Array.isArray(log.data_categories)) {\n        log.data_categories.forEach(cat => allCategories.add(cat));\n    }\n});\n\n// –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ session_id –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö\nconst uniqueSessionIds = [...new Set(auditLogs.map(l => l.session_id))];\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á—ë—Ç\nconst report = {\n    reportMetadata: {\n        title: 'GDPR –°—Ç–∞—Ç—å—è 30 - –ó–∞–ø–∏—Å—å –æ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ',\n        subtitle: '–ê—É–¥–∏—Ç-–æ—Ç—á—ë—Ç —Å—É–±—ä–µ–∫—Ç–∞ –¥–∞–Ω–Ω—ã—Ö',\n        generatedAt: new Date().toISOString(),\n        generatedBy: 'GDPR Compliance System',\n        reportFormat: searchParams.format,\n        queryParameters: {\n            sessionIds: searchParams.session_ids,\n            email: primaryEmail,\n            searchedBy: searchParams.email ? 'email' : 'session_id'\n        }\n    },\n    \n    controllerInformation: {\n        name: controller,\n        domain: primaryDomain,\n        role: CONFIG.companyRole,\n        contactDpo: dpoEmail\n    },\n    \n    dataSubjectInformation: {\n        email: primaryEmail,\n        name: primaryName,\n        sessionIds: uniqueSessionIds,\n        emailSources: userEmails.map(u => ({\n            sessionId: u.session_id,\n            email: u.email,\n            name: u.name,\n            source: u.source\n        }))\n    },\n    \n    dataSubjectSummary: {\n        sessionIds: uniqueSessionIds,\n        email: primaryEmail,\n        name: primaryName,\n        totalAuditRecords: auditLogs.length,\n        totalConsentRecords: consentRecords.length,\n        firstActivity: auditLogs[0]?.created_at || null,\n        lastActivity: auditLogs[auditLogs.length - 1]?.created_at || null,\n        dataCategories: Array.from(allCategories),\n        actionBreakdown: actionStats\n    },\n    \n    legalBasis: {\n        primaryBasis: CONFIG.legalBasis,\n        purposes: CONFIG.processingPurposes,\n        retentionPolicy: CONFIG.retentionPolicy\n    },\n    \n    consentHistory: consentRecords.map(consent => {\n        // –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º email –∏–∑ sessionEmailMap –µ—Å–ª–∏ –Ω–µ—Ç –≤ consent\n        const emailInfo = sessionEmailMap[consent.session_id] || {};\n        return {\n            sessionId: consent.session_id,\n            email: consent.user_email || emailInfo.email || null,\n            name: emailInfo.name || null,\n            consentGiven: consent.consent_given,\n            consentType: consent.consent_type,\n            privacyPolicyVersion: consent.privacy_policy_version,\n            isActive: consent.is_active,\n            createdAt: consent.created_at,\n            expiresAt: consent.expires_at,\n            revokedAt: consent.revoked_at,\n            revokeReason: consent.revoke_reason\n        };\n    }),\n    \n    processingActivities: auditLogs.map(log => {\n        let parsedDetails = {};\n        try {\n            parsedDetails = typeof log.details === 'string' ? JSON.parse(log.details) : (log.details || {});\n        } catch (e) {\n            parsedDetails = { raw: log.details };\n        }\n        \n        // –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º email –¥–ª—è —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏\n        const emailInfo = sessionEmailMap[log.session_id] || {};\n        \n        return {\n            id: log.id,\n            sessionId: log.session_id,\n            email: emailInfo.email || null,\n            name: emailInfo.name || null,\n            timestamp: log.created_at,\n            action: log.action,\n            actionDescription: getActionDescription(log.action),\n            gdprArticle: getGdprArticle(log.action),\n            purpose: log.purpose,\n            legalBasis: log.legal_basis,\n            controller: log.controller,\n            dataCategories: log.data_categories,\n            details: parsedDetails,\n            technicalInfo: {\n                ipAddress: log.ip_address,\n                userAgent: log.user_agent,\n                domain: log.domain\n            },\n            privacyPolicyVersion: log.privacy_policy_version\n        };\n    }),\n    \n    complianceStatement: {\n        declaration: '–≠—Ç–æ—Ç –æ—Ç—á—ë—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ —Å—Ç–∞—Ç—å–∏ 30 GDPR –¥–ª—è –≤–µ–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –æ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ.',\n        dataProtectionMeasures: CONFIG.dataProtectionMeasures,\n        dataSubjectRights: CONFIG.dataSubjectRights\n    }\n};\n\nfunction getActionDescription(action) {\n    const descriptions = {\n        'consent_given': '–°—É–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö –¥–∞–ª —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö',\n        'consent_declined': '–°—É–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç–∫–ª–æ–Ω–∏–ª —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö',\n        'consent_revoked': '–°—É–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç–æ–∑–≤–∞–ª —Ä–∞–Ω–µ–µ –¥–∞–Ω–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ',\n        'data_access': '–°—É–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∏–ª –¥–æ—Å—Ç—É–ø –∫ —Å–≤–æ–∏–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º –¥–∞–Ω–Ω—ã–º',\n        'data_export': '–°—É–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∏–ª —ç–∫—Å–ø–æ—Ä—Ç —Å–≤–æ–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö',\n        'data_erasure': '–°—É–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∏–ª —É–¥–∞–ª–µ–Ω–∏–µ —Å–≤–æ–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö',\n        'personal_data_collected': '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—ã–ª–∏ —Å–æ–±—Ä–∞–Ω—ã –æ—Ç —Å—É–±—ä–µ–∫—Ç–∞ –¥–∞–Ω–Ω—ã—Ö'\n    };\n    return descriptions[action] || action;\n}\n\nfunction getGdprArticle(action) {\n    const articles = {\n        'consent_given': '–°—Ç–∞—Ç—å—è 7 - –£—Å–ª–æ–≤–∏—è —Å–æ–≥–ª–∞—Å–∏—è',\n        'consent_declined': '–°—Ç–∞—Ç—å—è 7 - –£—Å–ª–æ–≤–∏—è —Å–æ–≥–ª–∞—Å–∏—è',\n        'consent_revoked': '–°—Ç–∞—Ç—å—è 7(3) - –ü—Ä–∞–≤–æ –æ—Ç–æ–∑–≤–∞—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ',\n        'data_access': '–°—Ç–∞—Ç—å—è 15 - –ü—Ä–∞–≤–æ –Ω–∞ –¥–æ—Å—Ç—É–ø',\n        'data_export': '–°—Ç–∞—Ç—å—è 20 - –ü—Ä–∞–≤–æ –Ω–∞ –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö',\n        'data_erasure': '–°—Ç–∞—Ç—å—è 17 - –ü—Ä–∞–≤–æ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ',\n        'personal_data_collected': '–°—Ç–∞—Ç—å—è 13/14 - –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è'\n    };\n    return articles[action] || '–°—Ç–∞—Ç—å—è 30 - –ó–∞–ø–∏—Å–∏ –æ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ';\n}\n\nreturn [{\n    json: {\n        report: report,\n        format: searchParams.format,\n        session_ids: searchParams.session_ids,\n        email: primaryEmail,\n        totalRecords: auditLogs.length\n    }\n}];"
      },
      "id": "f9a07d4a-f925-44c7-a937-7e4b81b7c20c",
      "name": "üìä Format Audit Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4032,
        -816
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "format-pdf",
              "leftValue": "={{ $json.format }}",
              "rightValue": "pdf",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3808,
        -816
      ],
      "id": "1dd2e2e3-d53c-4d94-865d-3e5c94c9bf20",
      "name": "‚ùì Is PDF?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "format-csv",
              "leftValue": "={{ $json.format }}",
              "rightValue": "csv",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3584,
        -720
      ],
      "id": "021bc435-5901-4dc9-bd9f-29b5c482a7b1",
      "name": "‚ùì Is CSV?"
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// üìÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è CSV\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst reportData = items[0].json;\nconst report = reportData.report;\nconst activities = report.processingActivities || [];\nconst dataSubject = report.dataSubjectInformation || {};\nconst sessionIds = dataSubject.sessionIds || report.reportMetadata?.queryParameters?.sessionIds || [];\nconst primaryEmail = dataSubject.email || report.dataSubjectSummary?.email || '';\nconst primaryName = dataSubject.name || report.dataSubjectSummary?.name || '';\n\nif (activities.length === 0) {\n    return [{\n        json: {\n            success: true,\n            format: 'csv',\n            filename: `gdpr_audit_report_${new Date().toISOString().split('T')[0]}.csv`,\n            content: '–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤',\n            contentType: 'text/csv; charset=utf-8',\n            totalRecords: 0\n        }\n    }];\n}\n\n// –§—É–Ω–∫—Ü–∏—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è CSV\nfunction escapeCSV(value) {\n    if (value === null || value === undefined) return '';\n    const str = String(value);\n    if (str.includes(',') || str.includes('\"') || str.includes('\\n')) {\n        return '\"' + str.replace(/\"/g, '\"\"') + '\"';\n    }\n    return str;\n}\n\n// –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç–∞ –≤ –Ω–∞—á–∞–ª–µ CSV\nconst metadata = [\n    `# GDPR –°—Ç–∞—Ç—å—è 30 –ê—É–¥–∏—Ç-–æ—Ç—á—ë—Ç`,\n    `# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: ${report.reportMetadata?.generatedAt || new Date().toISOString()}`,\n    `# Email —Å—É–±—ä–µ–∫—Ç–∞ –¥–∞–Ω–Ω—ã—Ö: ${primaryEmail || '–ù/–î'}`,\n    `# –ò–º—è —Å—É–±—ä–µ–∫—Ç–∞ –¥–∞–Ω–Ω—ã—Ö: ${primaryName || '–ù/–î'}`,\n    `# Session ID: ${sessionIds.join('; ') || '–ù/–î'}`,\n    `# –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä: ${report.controllerInformation?.name || '–ù/–î'}`,\n    `# –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${activities.length}`,\n    ``\n];\n\nconst headers = [\n    'ID', 'Session ID', 'Email', '–ò–º—è', '–í—Ä–µ–º—è', '–î–µ–π—Å—Ç–≤–∏–µ', '–û–ø–∏—Å–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è', '–°—Ç–∞—Ç—å—è GDPR',\n    '–¶–µ–ª—å', '–ü—Ä–∞–≤–æ–≤–æ–µ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ', '–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä', '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö', 'IP –∞–¥—Ä–µ—Å', '–î–æ–º–µ–Ω', '–î–µ—Ç–∞–ª–∏'\n];\n\nconst rows = activities.map(act => [\n    act.id,\n    act.sessionId,\n    act.email || primaryEmail,\n    act.name || primaryName,\n    act.timestamp,\n    act.action,\n    act.actionDescription,\n    act.gdprArticle,\n    act.purpose,\n    act.legalBasis,\n    act.controller,\n    Array.isArray(act.dataCategories) ? act.dataCategories.join('; ') : '',\n    act.technicalInfo?.ipAddress || '',\n    act.technicalInfo?.domain || '',\n    JSON.stringify(act.details || {})\n]);\n\n// BOM –¥–ª—è UTF-8 (—á—Ç–æ–±—ã Excel –ø—Ä–∞–≤–∏–ª—å–Ω–æ —á–∏—Ç–∞–ª –∫–∏—Ä–∏–ª–ª–∏—Ü—É)\nconst BOM = '\\uFEFF';\n\nconst csvContent = BOM + [\n    ...metadata,\n    headers.map(escapeCSV).join(','),\n    ...rows.map(row => row.map(escapeCSV).join(','))\n].join('\\n');\n\nreturn [{\n    json: {\n        success: true,\n        format: 'csv',\n        filename: `gdpr_audit_report_${new Date().toISOString().split('T')[0]}.csv`,\n        content: csvContent,\n        contentType: 'text/csv; charset=utf-8',\n        totalRecords: activities.length\n    }\n}];"
      },
      "id": "af595fb0-aefa-4095-9274-152b63acc286",
      "name": "üìÑ Generate CSV",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3360,
        -768
      ]
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// üìã –í–æ–∑–≤—Ä–∞—Ç JSON –æ—Ç—á—ë—Ç–∞\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst reportData = items[0].json;\nconst report = reportData.report;\nconst dataSubject = report.dataSubjectInformation || {};\nconst sessionIds = dataSubject.sessionIds || report.reportMetadata?.queryParameters?.sessionIds || [];\n\nreturn [{\n    json: {\n        success: true,\n        format: 'json',\n        filename: `gdpr_audit_report_${new Date().toISOString().split('T')[0]}.json`,\n        contentType: 'application/json',\n        totalRecords: reportData.totalRecords || 0,\n        summary: {\n            email: dataSubject.email || null,\n            name: dataSubject.name || null,\n            sessionIds: sessionIds,\n            totalActivities: report.dataSubjectSummary?.totalAuditRecords || 0,\n            totalConsents: report.dataSubjectSummary?.totalConsentRecords || 0\n        },\n        data: report\n    }\n}];"
      },
      "id": "4d6ac4a8-511d-42fe-8eca-ef9c0a7da7c9",
      "name": "üìã Return JSON",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3360,
        -608
      ]
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// üìÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF/HTML\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst reportData = items[0].json;\nconst report = reportData.report;\n\nconst hasData = report.processingActivities && report.processingActivities.length > 0;\nconst noDataMessage = report.message || '–ó–∞–ø–∏—Å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤';\n\n// –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—É–±—ä–µ–∫—Ç–µ –¥–∞–Ω–Ω—ã—Ö\nconst dataSubject = report.dataSubjectInformation || {};\nconst primaryEmail = dataSubject.email || report.dataSubjectSummary?.email || '–ù/–î';\nconst primaryName = dataSubject.name || report.dataSubjectSummary?.name || '';\nconst sessionIds = dataSubject.sessionIds || report.reportMetadata?.queryParameters?.sessionIds || [];\n\nconst html = `\n<!DOCTYPE html>\n<html lang=\"ru\">\n<head>\n    <meta charset=\"UTF-8\">\n    <title>GDPR –ê—É–¥–∏—Ç-–æ—Ç—á—ë—Ç</title>\n    <style>\n        * { margin: 0; padding: 0; box-sizing: border-box; }\n        body { font-family: 'Segoe UI', Arial, sans-serif; font-size: 11pt; line-height: 1.5; color: #333; padding: 40px; }\n        .header { text-align: center; border-bottom: 3px solid #2563eb; padding-bottom: 20px; margin-bottom: 30px; }\n        .header h1 { color: #1e40af; font-size: 22pt; margin-bottom: 5px; }\n        .header h2 { color: #64748b; font-size: 14pt; font-weight: normal; }\n        .meta { background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 25px; }\n        .meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }\n        .meta-item { font-size: 10pt; }\n        .meta-label { color: #64748b; font-weight: 600; }\n        .section { margin-bottom: 25px; }\n        .section-title { color: #1e40af; font-size: 14pt; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; margin-bottom: 15px; }\n        .info-box { background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; }\n        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }\n        .stat-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; text-align: center; }\n        .stat-value { font-size: 24pt; font-weight: bold; color: #2563eb; }\n        .stat-label { font-size: 9pt; color: #64748b; text-transform: uppercase; }\n        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 9pt; }\n        th { background: #1e40af; color: white; padding: 10px 8px; text-align: left; }\n        td { padding: 8px; border-bottom: 1px solid #e2e8f0; vertical-align: top; }\n        tr:nth-child(even) { background: #f8fafc; }\n        .action-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 8pt; font-weight: 600; }\n        .action-consent_given { background: #dcfce7; color: #166534; }\n        .action-consent_revoked { background: #fee2e2; color: #991b1b; }\n        .action-data_access { background: #dbeafe; color: #1e40af; }\n        .action-data_export { background: #fef3c7; color: #92400e; }\n        .action-data_erasure { background: #fce7f3; color: #9d174d; }\n        .action-personal_data_collected { background: #e0e7ff; color: #3730a3; }\n        .footer { margin-top: 40px; padding-top: 20px; border-top: 2px solid #e2e8f0; font-size: 9pt; color: #64748b; }\n        .compliance-list { list-style: none; }\n        .compliance-list li { padding: 5px 0; padding-left: 20px; position: relative; }\n        .compliance-list li::before { content: \"‚úì\"; position: absolute; left: 0; color: #22c55e; font-weight: bold; }\n        .no-data { text-align: center; padding: 40px; background: #fef3c7; border-radius: 8px; color: #92400e; }\n        .data-subject-box { background: #eff6ff; border: 1px solid #bfdbfe; padding: 15px; border-radius: 8px; margin-bottom: 20px; }\n        .data-subject-box h4 { color: #1e40af; margin-bottom: 10px; }\n        .session-id { font-family: monospace; font-size: 9pt; word-break: break-all; }\n        @media print { body { padding: 20px; } .section { page-break-inside: avoid; } }\n    </style>\n</head>\n<body>\n    <div class=\"header\">\n        <h1>GDPR –°—Ç–∞—Ç—å—è 30 - –û—Ç—á—ë—Ç –æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏</h1>\n        <h2>–ó–∞–ø–∏—Å—å –æ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ - –ê—É–¥–∏—Ç —Å—É–±—ä–µ–∫—Ç–∞ –¥–∞–Ω–Ω—ã—Ö</h2>\n    </div>\n    \n    <div class=\"meta\">\n        <div class=\"meta-grid\">\n            <div class=\"meta-item\"><span class=\"meta-label\">–û—Ç—á—ë—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω:</span> ${report.reportMetadata?.generatedAt || new Date().toISOString()}</div>\n            <div class=\"meta-item\"><span class=\"meta-label\">–ú–µ—Ç–æ–¥ –ø–æ–∏—Å–∫–∞:</span> ${report.reportMetadata?.queryParameters?.searchedBy === 'email' ? 'Email' : 'Session ID'}</div>\n            <div class=\"meta-item\"><span class=\"meta-label\">–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä:</span> ${report.controllerInformation?.name || '–ù/–î'}</div>\n            <div class=\"meta-item\"><span class=\"meta-label\">–î–æ–º–µ–Ω:</span> ${report.controllerInformation?.domain || '–ù/–î'}</div>\n        </div>\n    </div>\n    \n    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—É–±—ä–µ–∫—Ç–µ –¥–∞–Ω–Ω—ã—Ö -->\n    <div class=\"data-subject-box\">\n        <h4>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—É–±—ä–µ–∫—Ç–µ –¥–∞–Ω–Ω—ã—Ö</h4>\n        <div class=\"meta-grid\">\n            <div class=\"meta-item\"><span class=\"meta-label\">Email:</span> ${primaryEmail}</div>\n            <div class=\"meta-item\"><span class=\"meta-label\">–ò–º—è:</span> ${primaryName || '–ù/–î'}</div>\n        </div>\n        <div style=\"margin-top: 10px;\">\n            <div class=\"meta-item\"><span class=\"meta-label\">Session ID:</span> <span class=\"session-id\">${sessionIds.join(', ') || '–ù/–î'}</span></div>\n        </div>\n        <div class=\"meta-grid\" style=\"margin-top: 10px;\">\n            <div class=\"meta-item\"><span class=\"meta-label\">–í—Å–µ–≥–æ —Å–µ—Å—Å–∏–π:</span> ${sessionIds.length || 1}</div>\n            <div class=\"meta-item\"><span class=\"meta-label\">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:</span> ${[...new Set((dataSubject.emailSources || []).map(s => s.source))].join(', ') || '–ù/–î'}</div>\n        </div>\n    </div>\n    \n    ${!hasData ? `\n    <div class=\"no-data\">\n        <h3>‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>\n        <p>${noDataMessage}</p>\n    </div>\n    ` : `\n    <div class=\"section\">\n        <h3 class=\"section-title\">–°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>\n        <div class=\"stats-grid\">\n            <div class=\"stat-card\">\n                <div class=\"stat-value\">${report.dataSubjectSummary?.totalAuditRecords || 0}</div>\n                <div class=\"stat-label\">–í—Å–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ</div>\n            </div>\n            <div class=\"stat-card\">\n                <div class=\"stat-value\">${report.dataSubjectSummary?.totalConsentRecords || 0}</div>\n                <div class=\"stat-label\">–ó–∞–ø–∏—Å–µ–π —Å–æ–≥–ª–∞—Å–∏–π</div>\n            </div>\n            <div class=\"stat-card\">\n                <div class=\"stat-value\">${report.dataSubjectSummary?.dataCategories?.length || 0}</div>\n                <div class=\"stat-label\">–ö–∞—Ç–µ–≥–æ—Ä–∏–π –¥–∞–Ω–Ω—ã—Ö</div>\n            </div>\n        </div>\n        <div class=\"info-box\">\n            <strong>–ü–µ—Ä–∏–æ–¥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:</strong> ${report.dataSubjectSummary?.firstActivity || '–ù/–î'} ‚Äî ${report.dataSubjectSummary?.lastActivity || '–ù/–î'}\n        </div>\n    </div>\n    \n    <div class=\"section\">\n        <h3 class=\"section-title\">–ü—Ä–∞–≤–æ–≤–æ–µ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö</h3>\n        <div class=\"info-box\">\n            <p><strong>–ü—Ä–∞–≤–æ–≤–æ–µ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ:</strong> ${report.legalBasis?.primaryBasis || '–°–æ–≥–ª–∞—Å–∏–µ'}</p>\n            <p><strong>–¶–µ–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏:</strong> ${report.legalBasis?.purposes?.join(', ') || '–ù/–î'}</p>\n            <p><strong>–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö:</strong> ${report.dataSubjectSummary?.dataCategories?.join(', ') || '–ù–µ—Ç'}</p>\n        </div>\n    </div>\n    \n    <div class=\"section\">\n        <h3 class=\"section-title\">–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ</h3>\n        <table>\n            <thead>\n                <tr>\n                    <th style=\"width:12%\">–í—Ä–µ–º—è</th>\n                    <th style=\"width:10%\">–°–µ—Å—Å–∏—è</th>\n                    <th style=\"width:12%\">–î–µ–π—Å—Ç–≤–∏–µ</th>\n                    <th style=\"width:22%\">–°—Ç–∞—Ç—å—è GDPR</th>\n                    <th style=\"width:12%\">–¶–µ–ª—å</th>\n                    <th style=\"width:32%\">–î–µ—Ç–∞–ª–∏</th>\n                </tr>\n            </thead>\n            <tbody>\n                ${(report.processingActivities || []).map(act => `\n                <tr>\n                    <td>${act.timestamp ? new Date(act.timestamp).toLocaleString('ru-RU') : '–ù/–î'}</td>\n                    <td style=\"font-size:7pt;word-break:break-all;\">${(act.sessionId || '').slice(-12)}</td>\n                    <td><span class=\"action-badge action-${act.action}\">${(act.action || '').replace(/_/g, ' ')}</span></td>\n                    <td>${act.gdprArticle || '-'}</td>\n                    <td>${act.purpose || '-'}</td>\n                    <td>${act.actionDescription || '-'}<br><small style=\"color:#64748b\">IP: ${act.technicalInfo?.ipAddress || '–ù/–î'}</small></td>\n                </tr>\n                `).join('')}\n            </tbody>\n        </table>\n    </div>\n    \n    ${report.consentHistory && report.consentHistory.length > 0 ? `\n    <div class=\"section\">\n        <h3 class=\"section-title\">–ò—Å—Ç–æ—Ä–∏—è —Å–æ–≥–ª–∞—Å–∏–π</h3>\n        <table>\n            <thead>\n                <tr>\n                    <th>–î–∞—Ç–∞</th>\n                    <th>Email</th>\n                    <th>–ò–º—è</th>\n                    <th>–¢–∏–ø</th>\n                    <th>–°—Ç–∞—Ç—É—Å</th>\n                    <th>–û—Ç–æ–∑–≤–∞–Ω–æ</th>\n                </tr>\n            </thead>\n            <tbody>\n                ${report.consentHistory.map(c => `\n                <tr>\n                    <td>${c.createdAt ? new Date(c.createdAt).toLocaleString('ru-RU') : '–ù/–î'}</td>\n                    <td>${c.email || primaryEmail || '-'}</td>\n                    <td>${c.name || primaryName || '-'}</td>\n                    <td>${c.consentType || '-'}</td>\n                    <td>${c.isActive ? '<span style=\"color:#22c55e\">–ê–∫—Ç–∏–≤–Ω–æ</span>' : '<span style=\"color:#ef4444\">–ù–µ–∞–∫—Ç–∏–≤–Ω–æ</span>'}</td>\n                    <td>${c.revokedAt ? new Date(c.revokedAt).toLocaleString('ru-RU') : '-'}</td>\n                </tr>\n                `).join('')}\n            </tbody>\n        </table>\n    </div>\n    ` : ''}\n    `}\n    \n    <div class=\"section\">\n        <h3 class=\"section-title\">–ó–∞—è–≤–ª–µ–Ω–∏–µ –æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏</h3>\n        <div class=\"info-box\">\n            <p>${report.complianceStatement?.declaration || '–≠—Ç–æ—Ç –æ—Ç—á—ë—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ —Å—Ç–∞—Ç—å–∏ 30 GDPR.'}</p>\n        </div>\n        <div style=\"display:grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;\">\n            <div>\n                <h4 style=\"margin-bottom:10px; color:#1e40af;\">–ú–µ—Ä—ã –∑–∞—â–∏—Ç—ã –¥–∞–Ω–Ω—ã—Ö</h4>\n                <ul class=\"compliance-list\">\n                    ${(report.complianceStatement?.dataProtectionMeasures || []).map(m => `<li>${m}</li>`).join('')}\n                </ul>\n            </div>\n            <div>\n                <h4 style=\"margin-bottom:10px; color:#1e40af;\">–ü—Ä–∞–≤–∞ —Å—É–±—ä–µ–∫—Ç–∞ –¥–∞–Ω–Ω—ã—Ö</h4>\n                <ul class=\"compliance-list\">\n                    ${(report.complianceStatement?.dataSubjectRights || []).map(r => `<li>${r}</li>`).join('')}\n                </ul>\n            </div>\n        </div>\n    </div>\n    \n    <div class=\"footer\">\n        <p><strong>ID –æ—Ç—á—ë—Ç–∞:</strong> GDPR-${Date.now()}</p>\n        <p><strong>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω:</strong> ${report.reportMetadata?.generatedBy || 'GDPR Compliance System'}</p>\n        <p><strong>–°—É–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö:</strong> ${primaryEmail} ${primaryName ? '(' + primaryName + ')' : ''}</p>\n        <p><strong>–ö–æ–Ω—Ç–∞–∫—Ç DPO:</strong> ${report.controllerInformation?.contactDpo || '–ù/–î'}</p>\n        <p style=\"margin-top:15px; font-style:italic;\">–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–ø–∏—Å—å—é –æ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å–æ —Å—Ç–∞—Ç—å—ë–π 30 GDPR.</p>\n    </div>\n</body>\n</html>\n`;\n\nreturn [{\n    json: {\n        success: true,\n        format: 'pdf',\n        filename: `gdpr_audit_report_${new Date().toISOString().split('T')[0]}.html`,\n        content: html,\n        contentType: 'text/html',\n        totalRecords: reportData.totalRecords || 0\n    }\n}];"
      },
      "id": "ea7d0bcb-262c-469d-a033-7cc47df1167a",
      "name": "üìÑ Generate PDF/HTML",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3584,
        -928
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "X-GDPR-Report",
                "value": "audit"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -3136,
        -816
      ],
      "id": "380ca5c2-7638-4df1-bec8-f6c4aa252240",
      "name": "‚úÖ Respond"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {
          "responseCode": "={{ $json.error.status || 401 }}"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -5936,
        -640
      ],
      "id": "6a9e8da8-b1ff-414e-9dc5-31e1bf20e0af",
      "name": "‚ùå Error Response"
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// ‚ö†Ô∏è Email –Ω–µ –Ω–∞–π–¥–µ–Ω - –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst data = items[0].json;\n\nreturn [{\n    json: {\n        success: true,\n        format: data.format || 'json',\n        data: {\n            reportMetadata: {\n                title: 'GDPR –°—Ç–∞—Ç—å—è 30 - –ó–∞–ø–∏—Å—å –æ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ',\n                generatedAt: new Date().toISOString(),\n                queryParameters: { email: data.email }\n            },\n            message: '–°–µ—Å—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è email: ' + data.email,\n            processingActivities: [],\n            dataSubjectSummary: {\n                totalAuditRecords: 0,\n                email: data.email\n            }\n        },\n        totalRecords: 0\n    }\n}];"
      },
      "id": "7ede34f1-1003-44f9-ab55-0886a42e0c04",
      "name": "‚ö†Ô∏è No Sessions Found",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4624,
        -528
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "üåê Webhook: Audit Report": {
      "main": [
        [
          {
            "node": "‚öôÔ∏è CONFIG: Audit Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚öôÔ∏è CONFIG: Audit Report": {
      "main": [
        [
          {
            "node": "üîê Security Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîê Security Check": {
      "main": [
        [
          {
            "node": "‚ùì Auth Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Auth Check": {
      "main": [
        [
          {
            "node": "üì• Parse Request",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚ùå Error Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì• Parse Request": {
      "main": [
        [
          {
            "node": "‚ùì Has Session ID?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Has Session ID?": {
      "main": [
        [
          {
            "node": "üìã Prepare Direct Search",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üêò Find Sessions by Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üêò Find Sessions by Email": {
      "main": [
        [
          {
            "node": "üìã Prepare Session IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìã Prepare Session IDs": {
      "main": [
        [
          {
            "node": "‚ùì Sessions Found?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìã Prepare Direct Search": {
      "main": [
        [
          {
            "node": "‚ùì Sessions Found?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Sessions Found?": {
      "main": [
        [
          {
            "node": "üîß Prepare SQL Query",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚ö†Ô∏è No Sessions Found",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîß Prepare SQL Query": {
      "main": [
        [
          {
            "node": "üêò Get Audit Logs",
            "type": "main",
            "index": 0
          },
          {
            "node": "üêò Get Consent Records",
            "type": "main",
            "index": 0
          },
          {
            "node": "üêò Get User Emails",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üêò Get Audit Logs": {
      "main": [
        [
          {
            "node": "üîÄ Merge Audit+Consent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üêò Get Consent Records": {
      "main": [
        [
          {
            "node": "üîÄ Merge Audit+Consent",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "üêò Get User Emails": {
      "main": [
        [
          {
            "node": "üîÄ Merge All Data",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "üîÄ Merge Audit+Consent": {
      "main": [
        [
          {
            "node": "üîÄ Merge All Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÄ Merge All Data": {
      "main": [
        [
          {
            "node": "üìä Format Audit Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìä Format Audit Report": {
      "main": [
        [
          {
            "node": "‚ùì Is PDF?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Is PDF?": {
      "main": [
        [
          {
            "node": "üìÑ Generate PDF/HTML",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚ùì Is CSV?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Is CSV?": {
      "main": [
        [
          {
            "node": "üìÑ Generate CSV",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üìã Return JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìÑ Generate PDF/HTML": {
      "main": [
        [
          {
            "node": "‚úÖ Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìÑ Generate CSV": {
      "main": [
        [
          {
            "node": "‚úÖ Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìã Return JSON": {
      "main": [
        [
          {
            "node": "‚úÖ Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ö†Ô∏è No Sessions Found": {
      "main": [
        [
          {
            "node": "‚úÖ Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "production-ru-v1",
  "meta": {
    "instanceId": "9a2a948e1b1119e76dce477f4f08641c41898f344f4216cb90098437b1dcaf00"
  },
  "id": "BpgMx2X5bFeoqmaQ",
  "tags": []
}
